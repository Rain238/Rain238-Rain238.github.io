<!-- build time:Sat Aug 31 2024 18:05:36 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="baidu-site-verification" content="http://data.zz.baidu.com/urls?site=r.rainrem.top&token=x4FJjhRFfBhkMWK1"><link rel="alternate" type="application/rss+xml" title="雨的记忆" href="https://rainrem.top/rss.xml"><link rel="alternate" type="application/atom+xml" title="雨的记忆" href="https://rainrem.top/atom.xml"><link rel="alternate" type="application/json" title="雨的记忆" href="https://rainrem.top/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="计算机科学,Java,Java高级特性,Java类加载器"><link rel="canonical" href="https://rainrem.top/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/"><title>Java类加载器深入理解 - Java深入理解 - Java - 计算机科学 | Daring Traveler = 雨的记忆 = 程序是有生命的精灵</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Java类加载器深入理解</h1><div class="meta"><span class="item" title="创建时间：2023-11-28 21:32:40"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-11-28T21:32:40+08:00">2023-11-28</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>37k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>34 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Daring Traveler</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://www.dmoe.cc/random.php?842308"></li><li class="item" data-background-image="https://www.dmoe.cc/random.php?643870"></li><li class="item" data-background-image="https://www.dmoe.cc/random.php?846875"></li><li class="item" data-background-image="https://www.dmoe.cc/random.php?827035"></li><li class="item" data-background-image="https://www.dmoe.cc/random.php?137500"></li><li class="item" data-background-image="https://www.dmoe.cc/random.php?538644"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" itemprop="item" rel="index" title="分类于 计算机科学"><span itemprop="name">计算机科学</span></a><meta itemprop="position" content="1"></span><i class="ic i-angle-right"></i> <span itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/" itemprop="item" rel="index" title="分类于 Java"><span itemprop="name">Java</span></a><meta itemprop="position" content="2"></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" itemprop="item" rel="index" title="分类于 Java深入理解"><span itemprop="name">Java深入理解</span></a><meta itemprop="position" content="3"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://rainrem.top/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/02.jpg"><meta itemprop="name" content="Light Rain"><meta itemprop="description" content="程序是有生命的精灵, 我还在原地等你，你却已经忘记曾来过这里"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="雨的记忆"></span><div class="body md" itemprop="articleBody"><blockquote><p>本篇章源码基于 <code>Java 8</code> 版本，不同版本可能存在差异。<span class="exturl" data-url="aHR0cHM6Ly9naXRlZS5jb20vUmFpblNhdWNlL2phdmEtY2xhc3MtbG9hZGVyLWRlbW8=">🚀本篇章代码 Demo</span></p></blockquote><h1 id="类加载执行流程"><a class="anchor" href="#类加载执行流程">#</a> 类加载执行流程</h1><ul><li>我们每编写一个 <code>.java</code> 文件的时候都储蓄着需要执行的程序与逻辑。</li><li>这些 <code>.java</code> 文件经过 <code>Java</code> 编译器后会生成它对应的类加载文件也就是 <code>.class</code> 文件。</li><li>此时 <code>.class</code> 文件中保存着 <code>Java</code> 代码转换后的虚拟机指令。</li><li>当需要使用某个类时，虚拟机将会加载它的 <code>.class</code> 文件，并创建对应的 <code>class</code> 对象。</li><li>并将 <code>class</code> 文件加载到虚拟机的内存中，这便是类加载的执行流程，流程图如下，其中验证、准备、解析统一归属于链接。<br><img data-src="https://z1.ax1x.com/2023/11/13/piGHWl9.jpg" alt="piGHWl9.jpg"></li><li>加载：通过一个类的完全限定名查找此类的字节码文件，并利用字节码文件创建一个 <code>Class</code> 对象</li><li>验证：确保 <code>Class</code> 文件的字节流中包含信息符合当前虚拟机的要求，并检测会不会对虚拟机产生危害，主要包括四种验证：<ul><li>文件格式验证</li><li>元数据验证</li><li>字节码验证</li><li>符号引用验证</li></ul></li><li>准备：为类变量 (既 <code>static</code> 修饰的字段变量) 分配内存并设置该类变量的初始值为 <code>0</code> (如： <code>private static int num = 5</code> 这里只是将 <code>num</code> 初始化为 <code>0</code> ，至于 <code>5</code> 的值将会在初始化时赋值)，这里不包含 <code>final</code> 修饰的 <code>static</code> ，因为 <code>final</code> 在编译的时候就会分配了，值得注意的是：这里不会实例变量分配初始化，类变量会分配在方法区中，而实例变量是会随着对象一起分配到 <code>Java</code> 堆中。</li><li>解析：将常量池中的符号引用替换为直接引用的过程，符号引用就是一组符号来描述目标，可以是任何字面量，而直接引用就是直接指向目标地址，相对偏移量或一个间接定位到目标的句柄，如：<ul><li>类解析</li><li>接口解析</li><li>字段解析</li><li>类方法解析</li><li>接口方法解析</li></ul></li><li>初始化：类加载的最后阶段，若该类具有超类，则对其进行初始化，执行静态初始化器和静态初始化成员变量，如：前面只初始化了默认值的 <code>static</code> ，变量将会在这个阶段进行赋值，成员变量也将会被初始化。</li><li>这便是类加载的全部过程，而类加载器的任务是根据一个类的全限定名来读取此类二进制字节流到 <code>JVM</code> 中的，然后转换为一个与目标类对应的 <code>java.lang.Class</code> 对象实例。</li><li>虚拟机提供了三种方式的类加载器，如下：<ul><li><a href="#%E5%BC%95%E5%AF%BCbootstrap%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">引导 (Bootstrap) 类加载器</a></li><li><a href="#%E6%89%A9%E5%B1%95extension%E5%B9%B3%E5%8F%B0platform%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">扩展 (Extension)&amp; 平台 (Platform) 类加载器</a></li><li><a href="#%E7%B3%BB%E7%BB%9Fsystem%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%BA%94%E7%94%A8app%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">系统 (System) 类加载器</a></li></ul></li></ul><h1 id="三种方式类加载器"><a class="anchor" href="#三种方式类加载器">#</a> 三种方式类加载器</h1><h2 id="引导bootstrap类加载器"><a class="anchor" href="#引导bootstrap类加载器">#</a> 引导 (Bootstrap) 类加载器</h2><blockquote><p>由 <code>C/C++</code> 语言实现，启动类加载器，属于最高层， <code>JVM</code> 启动时创建，通常由于 os 相关的本地代码实现，是最根基的类加载器，没有对应的 <code>Java</code> 对象，因此在 <code>Java</code> 中只能用 <code>null</code> 来指代。</p></blockquote><h3 id="java8"><a class="anchor" href="#java8">#</a> Java8</h3><ul><li>启动类加载器主要加载的是 <code>JVM</code> 自身需要的类，这个类加载使用 <code>C++</code> 来实现的，是虚拟机自身的一部分，它负责将 <code>&lt;JAVA_HOME&gt;/lib</code> 路径下的核心类库或 <code>-Xbootclasspath</code> 参数指定的路径下的 <code>jar</code> 包加载到内存中，注意由于虚拟机是按照文件名识别加载 <code>jar</code> 包的，如果文件名不被虚拟机识别，即使将 <code>jar</code> 包放在 <code>lib</code> 目录下也没有任何作用，出于安全考虑 <code>Bootstrap</code> 启动类加载器只加载包名为 <code>java</code> 、 <code>javax</code> 、 <code>sun</code> 等开头的类。</li><li>总结：<ul><li>引导类加载器使用 <code>C/C++</code> 语言实现，嵌套在 <code>JVM</code> 内部。</li><li>用于加载 <code>Java</code> 核心类库。</li><li><code>JVM</code> 启动时创建，通常由于 os 相关的本地代码实现，是最根基的类加载器。</li><li>没有对应的 <code>Java</code> 对象，因此在 <code>Java</code> 中只能用 <code>null</code> 来指代。</li><li>不继承自 <code>java.lang.ClassLoader</code> ，没有父加载器。</li><li>还可用于加载扩展类加载器和应用程序类加载器，并指定为它们的父类加载器。</li><li>只加载包名为 <code>java</code> <code>javax</code> <code>sun</code> 开头的类文件。</li></ul></li></ul><blockquote><p>在 <code>JVM</code> 启动时通过 <code>Bootstrap ClassLoader</code> 加载 <code>rt.jar</code> , 并初始化 <code>sun.misc.Launcher</code> 从而创建 <code>Extension ClassLoader</code> 和 <code>Application ClassLoader</code> 的实例，下面代码是查看 <code>Bootstrap ClassLoader</code> 初始化了那些类库。</p></blockquote><figure class="highlight java"><figcaption data-lang="java"><span>GetBootstrapClassLoader.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span><span class="token class-name">Launcher</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="9"></td><td><pre> * @Description: 查看引导类加载器到底加载了那些核心类库</pre></td></tr><tr><td data-num="10"></td><td><pre> * @DateTime: 2023-12-03 00:21</pre></td></tr><tr><td data-num="11"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="12"></td><td><pre> **/</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetBootstrapClassLoader</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    URL<span class="token punctuation">[</span><span class="token punctuation">]</span> urLs <span class="token operator">=</span> <span class="token class-name">Launcher</span><span class="token punctuation">.</span><span class="token function">getBootstrapClassPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getURLs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>URL urL <span class="token operator">:</span> urLs<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>urL<span class="token punctuation">.</span><span class="token function">toExternalForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">/*</span></pre></td></tr><tr><td data-num="22"></td><td><pre>  打印结果：</pre></td></tr><tr><td data-num="23"></td><td><pre>  file:/C:/LightRainData/IDEA/JDK/JDK-1.8/jre/lib/resources.jar</pre></td></tr><tr><td data-num="24"></td><td><pre>  file:/C:/LightRainData/IDEA/JDK/JDK-1.8/jre/lib/rt.jar</pre></td></tr><tr><td data-num="25"></td><td><pre>  file:/C:/LightRainData/IDEA/JDK/JDK-1.8/jre/lib/sunrsasign.jar</pre></td></tr><tr><td data-num="26"></td><td><pre>  file:/C:/LightRainData/IDEA/JDK/JDK-1.8/jre/lib/jsse.jar</pre></td></tr><tr><td data-num="27"></td><td><pre>  file:/C:/LightRainData/IDEA/JDK/JDK-1.8/jre/lib/jce.jar</pre></td></tr><tr><td data-num="28"></td><td><pre>  file:/C:/LightRainData/IDEA/JDK/JDK-1.8/jre/lib/charsets.jar</pre></td></tr><tr><td data-num="29"></td><td><pre>  file:/C:/LightRainData/IDEA/JDK/JDK-1.8/jre/lib/jfr.jar</pre></td></tr><tr><td data-num="30"></td><td><pre>  file:/C:/LightRainData/IDEA/JDK/JDK-1.8/jre/classes</pre></td></tr><tr><td data-num="31"></td><td><pre> */</pre></td></tr></table></figure><h3 id="java9"><a class="anchor" href="#java9">#</a> Java9</h3><ul><li>自从 <code>Java 9</code> 引入了模块特性后，负责加载启动时的基础模块类有以下几种：<ul><li><code>java.base</code></li><li><code>java.management</code></li><li><code>java.xml</code></li></ul></li><li>除了启动类加载器之外，其它的类加载器都是 <code>java.lang.ClassLoader</code> 的子类，因此有对应的 <code>Java</code> 对象。</li><li>这些类加载器需要先由另一个类加载器，比如说启动类加载器，加载至 <code>Java</code> 虚拟机中方能执行类加载。</li></ul><h2 id="扩展extension平台platform类加载器"><a class="anchor" href="#扩展extension平台platform类加载器">#</a> 扩展 (Extension)&amp; 平台 (Platform) 类加载器</h2><h3 id="java8-扩展extension"><a class="anchor" href="#java8-扩展extension">#</a> Java8 - 扩展 (Extension)</h3><ul><li>扩展类加载器是 <code>Sun</code> 公司实现的，现已被 <code>Oracle</code> 收购， <code>sun.misc.Launcher$ExtClassLoader</code> 类由 <code>Java</code> 语言实现。</li><li>它是 <code>Launcher</code> 的静态内部类，它负责加载 <code>&lt;JAVA_HOME&gt;/lib/ext</code> 目录下或者由系统变量 <code>-Djava.ext.dirs</code> 路径中的类库。</li><li>负责加载一些扩展的系统类，如： <code>Xml</code> <code>加密</code> <code>压缩</code> 相关的功能类等。</li><li>可以供开发者直接使用标准扩展类加载器来加载。</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>Launcher.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlOHUyMTEtbGF0ZXItYXJjaGl2ZS1kb3dubG9hZHMuaHRtbA==">参考JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">sun<span class="token punctuation">.</span>misc</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * This class is used by the system to launch the main application.</pre></td></tr><tr><td data-num="5"></td><td><pre> */</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Launcher</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>  <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ExtClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">URLClassLoader</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token comment">//ExtClassLoader 类中获取路径的代码</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getExtDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token comment">// 加载 & lt;JAVA_HOME>/lib/ext 目录中的类库</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.ext.dirs"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dirs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">StringTokenizer</span> st <span class="token operator">=</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                <span class="token keyword">new</span> <span class="token class-name">StringTokenizer</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> <span class="token class-name">File</span><span class="token punctuation">.</span>pathSeparator<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token keyword">int</span> count <span class="token operator">=</span> st<span class="token punctuation">.</span><span class="token function">countTokens</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        dirs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">[</span>count<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          dirs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token function">nextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        dirs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token keyword">return</span> dirs<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="java9-平台platform"><a class="anchor" href="#java9-平台platform">#</a> Java9 - 平台 (Platform)</h3><blockquote><p>从 <code>Java 9</code> 替换为了平台类加载器，为何要替换？ <code>Java 8</code> 主要加载 <code>jre/lib</code> 下的 <code>ext</code> 扩展 <code>jar</code> 包时使用，这样的操作并不推荐，而 <code>Java 9</code> 更新了模块化就更无需这样扩展的类加载器了。</p></blockquote><ul><li>只要负责加载一些相对次要，但又通用的类。</li><li>加载一些平台相关模块如：<ul><li><code>java.scripting</code></li><li><code>java.compiler.*</code></li><li><code>java.corba.*</code></li></ul></li></ul><h2 id="系统system类加载器应用app类加载器"><a class="anchor" href="#系统system类加载器应用app类加载器">#</a> 系统 (System) 类加载器 &amp; 应用 (App) 类加载器</h2><ul><li><code>系统类加载器</code> 也被称为 <code>应用程序加载器</code> 是 <code>Sun</code> 公司实现的 <code>sun.misc.Launcher$AppClassLoader</code> 。</li><li>它负责加载系统类路径 <code>java -classpath</code> 或 <code>-D java.class.path</code> 指定路径下的类库，也就是我们经常用到的 <code>classpath</code> 路径。</li><li>开发者可以直接使用 <code>系统类加载器</code> ，一般情况下该类加载是程序中默认的类加载器，通过 <code>ClassLoader.getSystemClassLoader()</code> 方法可以获取到该类加载器。</li><li>在 <code>Java</code> 日常应用程序开发中，类的加载几乎由上述 <code>3</code> 种类加载器相互配合执行的，在必要时我们还可以自定义类加载器，需要注意的是 <code>Java</code> 虚拟机对 <code>class</code> 文件采用的是按需加载的方式。</li><li>就是说当需要使用该类时才会将它的 <code>class</code> 文件加载到内存中生成主要分为以下 <code>class</code> 对象，而且加载某个类的 <code>class</code> 文件时， <code>Java</code> 虚拟机采用的是<a href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%BC%8F"> <code>双亲委派模式</code> </a>，即把当前请求交由父类处理，它是一种任务委派模式。</li></ul><h1 id="双亲委派模式"><a class="anchor" href="#双亲委派模式">#</a> 双亲委派模式</h1><h2 id="双亲委派工作原理"><a class="anchor" href="#双亲委派工作原理">#</a> 双亲委派工作原理</h2><div class="note danger no-icon"><p>双亲委派模式要求除了顶层的启动类加载器外，其余的类加载器都应当有自己的父类加载器， <code>注意</code> ：双亲委派模式中的父子关系并非通常的类继承关系，而是采用组合关系来复用父类加载器的相关代码。</p></div><p><img data-src="https://z1.ax1x.com/2023/12/03/piyddVf.jpg" alt="piyddVf.jpg"></p><ul><li>双亲委派模式是 <code>Java 1.2</code> 后引入的，其工作原理就是如果：一个类加载器收到了类加载请求，它并不会自己先去加载，而是把这个请求委托给父类的加载器去执行。</li><li>如果父类加载器还存在其父类加载器，则进一步向上委托，以此类推，请求最终将到达顶层的启动类加载器，如果父类加载器可以完成类加载任务，就成功返回。</li><li>倘若父类加载器无法完成此加载任务，子加载器才会尝试自己去加载，这就是双亲委派模式。</li><li>俗话说就是每个儿子都很懒，有活就先给父亲干，直到父亲说这事我也干不了时，儿子才会自己想办法去做。</li></ul><h2 id="双亲委派主要用途"><a class="anchor" href="#双亲委派主要用途">#</a> 双亲委派主要用途</h2><ul><li>双亲委派的好处就是 <code>Java</code> 类随着它的类加载器一起具备了一种带有优先级的层级关系，通过这种层级关系可以避免类的重复加载。</li><li>当父类加载了该类时，其子类就没必要再加载了，其次考虑到安全因素 <code>Java</code> 核心 <code>API</code> 中定义类型不会被随意替换。</li><li>假设通过网络传递了一个名为 <code>java.lang.Integer</code> 类，通过双亲委派模式传递到启动类加载器，而启动类加载器在核心 <code>Java API</code> 中发现这个名称的类已被加载，之后并不会重新加载传递过来的 <code>java.lang.Integer</code> 类，而是直接返回已加载过的 <code>Integer.class</code> 对象。</li><li>这样做的原因还有一个就是防止核心 <code>API</code> 被随意篡改，如果：我们在 <code>classpath</code> 路径下自定义一个名为 <code>java.lang.Student</code> 类呢？该类在 <code>java.lang</code> 包下并不存在，经过双亲委派模式传递到启动类加载器中，由于父类加载器路径下并没有该类，所以不会被加载。</li><li>这将会反向委托给子类加载器来加载，最终会通过系统类加载器加载该类，但这样做是不被允许的，因为 <code>java.lang</code> 是核心 <code>API</code> ，是需要访问权限的，强制加载将会抛出 <code>java.lang.SecurityException: Prohibited package name: java.lang</code> 的异常。</li></ul><blockquote><p>所以是无论如何都无法加载成功的，下面是用代码在 <code>Java</code> 中定义的类加载器和 <code>双亲委派模式</code> 的实现。</p></blockquote><h2 id="双亲委派关系图"><a class="anchor" href="#双亲委派关系图">#</a> 双亲委派关系图</h2><p><img data-src="https://z1.ax1x.com/2023/12/04/piyBUq1.png" alt="piyBUq1.png"></p><ul><li>上图中可以看出顶层类加载器是 <code>ClassLoader</code> 类，它是一个抽象类，所有的类加载器都继承自 <code>ClassLoader</code> (不包括启动类加载器)。</li><li><code>ClassLoader</code> 中的几个比较重要的方法如下有：<ul><li><a href="#loadclasssting">loadClass(String)</a></li><li><a href="#findclasssting">findClass(String)</a></li><li><a href="#defineclassbyte-b-int-off-int-len">defineClass(byte[], int off, int len)</a></li><li><a href="#resolveclassclass-c">resolveClass(Class&lt;?&gt; c)</a></li></ul></li><li>上述 4 个方法都 <code>ClassLoader</code> 类中的比较重要的方法，也是我们可能会经常用到的方法。</li></ul><h2 id="classloader常用方法"><a class="anchor" href="#classloader常用方法">#</a> ClassLoader 常用方法</h2><h3 id="loadclasssting"><a class="anchor" href="#loadclasssting">#</a> loadClass(Sting)</h3><ul><li>该方法加载指定名称 (包括包名) 的二进制类型，该方法在 <code>JDK 1.2</code> 之后不在建议开发者重写但开发者可以直接调用该方法。</li><li><code>loadClass()</code> 方法是 <code>ClassLoader</code> 类自己实现的，该方法中的逻辑就是 <code>双亲委派模式</code> 的实现。</li><li>下面是 <code>loadClass(String name, boolean resolve)</code> 方法的源码，它是一个重载方法， <code>resolve</code> 参数代表是否生成 <code>class</code> 对象的同时进行解析相关操作。</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>ClassLoader.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlOHUyMTEtbGF0ZXItYXJjaGl2ZS1kb3dubG9hZHMuaHRtbA==">参考JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>lang</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token function">getClassLoadingLock</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token comment">// 首先从缓存中查找类是否已被加载</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            <span class="token comment">// First, check if the class has already been loaded -> 首先检查类是否已经加载</span></pre></td></tr><tr><td data-num="10"></td><td><pre>            <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                <span class="token keyword">long</span> t0 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>                    <span class="token comment">// 如果存在父类加载器优先由父类加载器加载类</span></pre></td></tr><tr><td data-num="15"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                        <span class="token comment">// 调用父类加载器的 loadClass 方法加载类</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                        c <span class="token operator">=</span> parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                        <span class="token comment">// 如果没有父类则委托给引导类加载器去加载</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                        c <span class="token operator">=</span> <span class="token function">findBootstrapClassOrNull</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                    <span class="token comment">// 如果抛出该异常说明父类加载器无法加载类</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                    <span class="token comment">// ClassNotFoundException thrown if class not found -> 如果找不到类则抛出 ClassNotFoundException</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                    <span class="token comment">//from the non-null parent class loader -> 从非 null 父类加载器</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                    <span class="token comment">// If still not found, then invoke findClass in order -> 如果仍未找到，则按顺序调用 findClass</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                    <span class="token comment">//to find the class -> 找到 class</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    <span class="token keyword">long</span> t1 <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">nanoTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    <span class="token comment">// 如果都没有找到则通过自定义实现的 findClass 去查找并加载</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                    c <span class="token operator">=</span> <span class="token function">findClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre></pre></td></tr><tr><td data-num="35"></td><td><pre>                    <span class="token comment">//this is the defining class loader; record the stats -> 这是定义类加载器记录统计信息</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                    <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getParentDelegationTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addTime</span><span class="token punctuation">(</span>t1 <span class="token operator">-</span> t0<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>                    <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClassTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addElapsedTimeFrom</span><span class="token punctuation">(</span>t1<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                    <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span>PerfCounter</span><span class="token punctuation">.</span><span class="token function">getFindClasses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>            <span class="token comment">// 是否需要在加载时进行解析</span></pre></td></tr><tr><td data-num="42"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token keyword">return</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>当类加载请求到来时，先从缓存中查找该类对象，如果存在直接返回，不存在则交给该类加载器的父类加载器去加载。</li><li>若没有父类加载器则交给顶级启动类加载器去加载，最后倘若扔没有找到，则使用 <code>findClass()</code> 方法去加载。</li></ul><blockquote><p>从 <code>loadClass</code> 实现也可以知道如果不想重新定义加载类的规则，也没有复杂的逻辑，只想在运行时加载自己指定的类，我们可以直接使用 <code>this.getClass().getClassLoader().loadClass('className')</code> 这样就可以直接调用 <code>ClassLoader</code> 的 <code>loadClass</code> 方法获取到 <code>class</code> 对象了。</p></blockquote><h3 id="findclasssting"><a class="anchor" href="#findclasssting">#</a> findClass(Sting)</h3><ul><li><code>JDK 1.2</code> 之前，在自定义类加载时，总会去继承 <code>ClassLoader</code> 类并重写 <code>loadClass</code> 方法，从而实现自定义的类加载。</li><li><code>JDK 1.2</code> 之后不再建议调用者去覆盖 <code>loadClass()</code> 方法，而是建议把自定义的类加载逻辑写在 <code>findClass()</code> 方法中。</li><li><code>findClass()</code> 方法是在 <code>loadClass()</code> 方法中被调用的，当 <code>loadClass()</code> 方法中父类加载器加载失败后，则会调用自己的 <code>findClass()</code> 方法来完成类加载。</li><li>这样就可以保证自定义的类加载器也符合 <code>双亲委派模式</code> 了，但需要注意的是 <code>ClassLoader</code> 类中并没有实现 <code>findClass()</code> 方法的具体逻辑，取而代之的是抛出 <code>ClassNotFoundException</code> 异常。</li><li>同时应该知道的是 <code>findClass()</code> 方法通常是和 <code>defineClass()</code> 方法一起使用的。</li><li><code>ClassLoader</code> 类中的 <code>findClass()</code> 方法源码如下：</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>ClassLoader.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlOHUyMTEtbGF0ZXItYXJjaGl2ZS1kb3dubG9hZHMuaHRtbA==">参考JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>lang</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   * 实现自定义类的加载器需要子类重写此方法</pre></td></tr><tr><td data-num="6"></td><td><pre>   * 默认抛出 ClassNotFoundException</pre></td></tr><tr><td data-num="7"></td><td><pre>   */</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h3 id="defineclassbyte-b-int-off-int-len"><a class="anchor" href="#defineclassbyte-b-int-off-int-len">#</a> defineClass(byte[] b, int off, int len)</h3><ul><li><code>defineClass()</code> 方法是用来将 <code>byte</code> 字节流解析成 <code>JVM</code> 能够识别的 <code>Class</code> 对象 ( <code>ClassLoader</code> 中已实现该方法逻辑)</li><li>通过这个方法不仅能够通过 <code>class</code> 文件实例化 <code>class</code> 对象，还可以通过其它方式实例化 <code>class</code> 对象，如：通过网络接收一个类的字节码，然后转换为 <code>byte</code> 字节流创建对应的 <code>class</code> 对象。</li><li><code>defineClass()</code> 方法通常与 <code>findClass()</code> 方法一起使用，一般情况下，在自定义类加载器时会直接覆盖 <code>ClassLoader</code> 的 <code>findClass()</code> 方法并编写加载规则。</li><li>最后取得要加载类的字节码后转换成流，然后调用 <code>defineClass()</code> 方法生成类的 <code>class</code> 对象，下面是简单案例代码。</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>OverrideFindClass.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Files</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="11"></td><td><pre> * @Description: 重写 FindClass 方法示例代码</pre></td></tr><tr><td data-num="12"></td><td><pre> * @DateTime: 2023-12-03 00:13</pre></td></tr><tr><td data-num="13"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="14"></td><td><pre> **/</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OverrideFindClass</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>   * 文件扩展名</pre></td></tr><tr><td data-num="18"></td><td><pre>   */</pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> FILE_EXTENSION <span class="token operator">=</span> <span class="token string">".class"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>   * .class 文件路径</pre></td></tr><tr><td data-num="22"></td><td><pre>   */</pre></td></tr><tr><td data-num="23"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> filePath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="26"></td><td><pre>   * 构造方法</pre></td></tr><tr><td data-num="27"></td><td><pre>   *</pre></td></tr><tr><td data-num="28"></td><td><pre>   * @param filePath .class 文件路径</pre></td></tr><tr><td data-num="29"></td><td><pre>   */</pre></td></tr><tr><td data-num="30"></td><td><pre>  <span class="token keyword">public</span> <span class="token class-name">OverrideFindClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>filePath <span class="token operator">=</span> filePath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="35"></td><td><pre>   * 重写获取类的字节码并创建 class 对象的逻辑</pre></td></tr><tr><td data-num="36"></td><td><pre>   *</pre></td></tr><tr><td data-num="37"></td><td><pre>   * @param className 全限定类名称</pre></td></tr><tr><td data-num="38"></td><td><pre>   * @return Class&lt;?> 任意 class 类型对象</pre></td></tr><tr><td data-num="39"></td><td><pre>   */</pre></td></tr><tr><td data-num="40"></td><td><pre>  <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="41"></td><td><pre>  <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token comment">// 获取字节码的字节数组</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClassData</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    <span class="token comment">// 调用父类中的 defineClass 方法将字节流解析成 JVM 能够识别的 Class 对象并返回</span></pre></td></tr><tr><td data-num="45"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="47"></td><td><pre></pre></td></tr><tr><td data-num="48"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="49"></td><td><pre>   * 读取字节码流的方法</pre></td></tr><tr><td data-num="50"></td><td><pre>   *</pre></td></tr><tr><td data-num="51"></td><td><pre>   * @param className 对象全限定名称</pre></td></tr><tr><td data-num="52"></td><td><pre>   * @return byte [] 字节数组</pre></td></tr><tr><td data-num="53"></td><td><pre>   */</pre></td></tr><tr><td data-num="54"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getClassData</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token comment">// 创建 InputStream 对象获取字节输入流</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token comment">// 定义一个字节数组</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token comment">// 创建 ByteArrayOutputStream 获取字节输出流</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token class-name">ByteArrayOutputStream</span> byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token comment">// 将字符串中的 "." 全部替换为 “\\”</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      <span class="token comment">// 获取全限定名称类路径如：top.rem.rain.NotEqualClassTest -> top\rem\rain\NotEqualClassTest</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      className <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      <span class="token comment">// 读取.class 文件到 InputStream 流中</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      inputStream <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">newInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> className <span class="token operator">+</span> FILE_EXTENSION<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token comment">//new ByteArrayOutputStream 获取字节输出流对象</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>      <span class="token keyword">int</span> ch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>      <span class="token comment">//inputStream 字节流读取到 - 1 为结束</span></pre></td></tr><tr><td data-num="71"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>ch <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>        <span class="token comment">// 将字节流中的数据写入到字节输出流中 inputStream -> byteArrayOutputStream</span></pre></td></tr><tr><td data-num="73"></td><td><pre>        byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>      <span class="token comment">// 将字节输出流转换为字节数组并赋值到 data 中</span></pre></td></tr><tr><td data-num="76"></td><td><pre>      data <span class="token operator">=</span> byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        <span class="token keyword">assert</span> inputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        <span class="token keyword">assert</span> byteArrayOutputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">return</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="91"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>注意：如果直接调用 <code>defineClass()</code> 方法生成类的 <code>class</code> 对象，这个类的 <code>class</code> 对象并没有解析 (可以理解为链接阶段，解析是链接的最后一步)，其解析操作需要等待初始化阶段进行。</p></blockquote><h3 id="resolveclassclass-c"><a class="anchor" href="#resolveclassclass-c">#</a> resolveClass(Class&lt;?&gt; c)</h3><blockquote><p>使用该方法可以使用类的 <code>Class</code> 对象创建完成并同时被解析，前面我们说链接阶段主要是对字节码进行验证，为类变量分配内存并设置初始值，同时将字节码文件中的符号引用替换为直接引用。</p></blockquote><div class="note danger no-icon"><p>上述 4 个方法都 <code>ClassLoader</code> 类中的比较重要的方法，也是我们可能会经常用到的方法。</p></div><h2 id="sercureclassloader扩展-classloader"><a class="anchor" href="#sercureclassloader扩展-classloader">#</a> SercureClassLoader 扩展 - ClassLoader</h2><h3 id="urlclassloaderurlclasspath"><a class="anchor" href="#urlclassloaderurlclasspath">#</a> URLClassLoader&amp;URLClassPath</h3><ul><li>来看 <code>SercureClassLoader</code> 扩展了 <code>ClassLoader</code> 新增了几个与使用相关的代码源 (对代码源的的位置及证书的验证) 和权限定义类验证 (主要指对 <code>class</code> 源码的访问权限) 的方法。</li><li>我们更多是与它的子类 <code>URLClassLoader</code> 有所关联， <code>ClassLoader</code> 是一个抽象类，很多方法是空方法并没有实现，如： <code>findClass()</code> <code>findResource()</code> 等方法。</li><li>而 <code>URLClassLoader</code> 类为这些方法提供了具体实现，新增了 <code>URLClassPath</code> 类协助取得 <code>Class</code> 字节码流等功能。</li><li>在编写自定义类加载器时如果没有过于复杂的需求，可以直接继承 <code>URLClassLoader</code> 类，就可以避免自己编写 <code>findClass()</code> 方法及其获取字节码流的方法了。<br><img data-src="https://z1.ax1x.com/2023/12/01/pisGWin.png" alt="pisGWin.png"></li><li>从类图结构来看 <code>URLClassLoader</code> 中存在一个 <code>URLClassPath</code> 类，通过这个类就可以找到要加载的字节码流。</li><li>就是说 <code>URLCLassPath</code> 类负责找到要加载的字节码后再读取字节流，最后通过 <code>defineClass()</code> 方法创建类的 <code>class</code> 对象。</li><li>从 <code>URLClassLoader</code> 类的结构图可以看出其构造方法都有一个必须传递的参数 <code>URL[]</code> ，该参数的元素是代表字节码文件的路径。</li><li>在创建 <code>URLClassLoader</code> 对象时必须要指定这个类加载器要到哪个目录下寻找要加载的 <code>class</code> 文化。</li><li>同时应该<span class="red">注意：</span> <code>URL[]</code> 是 <code>URLCLassPath</code> 类的必传参数，在创建 <code>URLClassPath</code> 对象时，会根据传递的 <code>URL</code> 数组中的路径判断是文件还是 <code>jar</code> 包。</li><li>根据不同的路径创建 <code>FileLoader</code> 或者 <code>JarLoader</code> 或默认 <code>Loader</code> 类去加载相应路径下的 <code>class</code> 文件。</li><li>而当 <code>JVM</code> 调用 <code>findClass()</code> 方法时就由 <code>Loader</code> <code>FileLoader</code> <code>JarLoader</code> 这三个加载器中的一个将 <code>class</code> 字节码流文件加载到内存中，最后利用字节码流创建类的 <code>class</code> 对象。</li><li><span class="label danger">注意事项:</span> 如果我们在定义类加载器时选择继承 <code>ClassLoader</code> 类而非 <code>URLClassLoader</code> 时，必须自己实现 <code>findClass()</code> 方法的具体加载逻辑以及获取字节码流的逻辑。</li></ul><div class="note danger no-icon"><p>了解完 <code>URLClassLoader</code> 后下面来看剩余的两个类加载器： <code>SystemClassLoader(系统类加载器)</code> 也被称为 <code>AppClassLoader(应用程序加载器)</code> 和 <code>ExtClassLoader(扩展类加载器)</code> 扩展类加载器是 <code>Java 8</code> 中的， <code>Java 9</code> 之后将扩展改为了平台 <code>PlatformClassLoader(平台类加载器)</code> ，此处使用 <code>Java 8</code> 版本</p></div><h3 id="appsystemclassloaderextclassloader"><a class="anchor" href="#appsystemclassloaderextclassloader">#</a> App(System)ClassLoader&amp;ExtClassLoader</h3><ul><li>这两个类都继承自 <code>URLClassLoader</code> 类， <code>ExtClassLoader</code> 和 <code>AppClassLoader</code> 是 <code>sun.misc.Launcher</code> 中的静态内部类。</li><li><code>sun.misc.Launcher</code> 主要被系统用于启动主应用程序， <code>ExtClassLoader</code> 和 <code>AppClassLoader</code> 都是由 <code>sun.misc.Launcher</code> 创建的，来看结构图如下。<br><img data-src="https://z1.ax1x.com/2023/12/02/pisNypn.png" alt="pisNypn.png"><br><img data-src="https://z1.ax1x.com/2023/12/02/pisNRmT.png" alt="pisNRmT.png"></li><li>我们发现 <code>ExtClassLoader</code> 并没有重写 <code>loadClass()</code> 方法，这足矣证明其遵循 <code>双亲委派模式</code> 。</li><li>而 <code>AppClassLoader</code> 重写了 <code>loadClass()</code> 方法，但最终调用的还是父类的 <code>loadClass()</code> 方法，因此也遵循 <code>双亲委派模式</code> ，重写方法源码如下。</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>Launcher.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlOHUyMTEtbGF0ZXItYXJjaGl2ZS1kb3dubG9hZHMuaHRtbA==">参考JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">sun<span class="token punctuation">.</span>misc</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Launcher</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="5"></td><td><pre>     * The class loader used for loading from java.class.path.</pre></td></tr><tr><td data-num="6"></td><td><pre>     * runs in a restricted security context.</pre></td></tr><tr><td data-num="7"></td><td><pre>     */</pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">AppClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">URLClassLoader</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre>         * Override loadClass so we can checkPackageAccess.</pre></td></tr><tr><td data-num="11"></td><td><pre>         */</pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token keyword">boolean</span> resolve<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token keyword">int</span> i <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>                <span class="token class-name">SecurityManager</span> sm <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                    sm<span class="token punctuation">.</span><span class="token function">checkPackageAccess</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ucp<span class="token punctuation">.</span><span class="token function">knownToNotExist</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>                <span class="token comment">// The class of the given name is not found in the parent</span></pre></td></tr><tr><td data-num="24"></td><td><pre>                <span class="token comment">// class loader as well as its local URLClassPath.</span></pre></td></tr><tr><td data-num="25"></td><td><pre>                <span class="token comment">// Check if this class has already been defined dynamically;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>                <span class="token comment">// if so, return the loaded class; otherwise, skip the parent</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token comment">// delegation and findClass.</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> c <span class="token operator">=</span> <span class="token function">findLoadedClass</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                <span class="token keyword">if</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                        <span class="token function">resolveClass</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>                    <span class="token keyword">return</span> c<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token comment">// 此处返回依旧调用的是父类中的 loadClass 方法</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> resolve<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>无论是 <code>ExtClassLoader</code> 还是 <code>AppClassLoader</code> 都继承自 <code>URLClassLoader</code> 类，因此它们都遵守 <code>双亲委派模式</code> 。</li><li>到此处我们对 <code>CLassLoader</code> <code>URLClassLoader</code> <code>ExtClassLoader</code> <code>AppClassLoader</code> 及 <code>Launcher</code> 类之间的关系有了比较清晰地了解。</li></ul><blockquote><p>下面我们将通过代码来阐明，上面的每个类加载器的父类到底是谁。</p></blockquote><h1 id="类加载器之间的关系"><a class="anchor" href="#类加载器之间的关系">#</a> 类加载器之间的关系</h1><ul><li>类加载器间的关系并非指继承关系，主要分为以下 <code>4</code> 点：<ul><li><a href="#%E5%BC%95%E5%AF%BCbootstrap%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><code>BootstrapClassLoader(引导类加载器)</code> </a>也被称为启动类加载器，由 <code>C++</code> 实现，没有父类。</li><li><a href="#java8-%E6%89%A9%E5%B1%95extension"><code>ExtClassLoader(扩展类加载器)</code> </a>在 <code>Java 9</code> 之后替换为了<a href="#java9-%E5%B9%B3%E5%8F%B0platform"> <code>PlatformClassLoader(平台类加载器)</code> </a>，由 <code>Java</code> 实现其父类加载器为 <code>null</code> 。</li><li><a href="#%E7%B3%BB%E7%BB%9Fsystem%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%BA%94%E7%94%A8app%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><code>SystemClassLoader(系统类加载器)</code> </a>或者称为<a href="#%E7%B3%BB%E7%BB%9Fsystem%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%BA%94%E7%94%A8app%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"> <code>AppClassLoader(应用类加载器)</code> </a>，由 <code>Java</code> 实现其父类加载器为 <code>ExtClassLoader</code> 。</li><li>自定义类加载器其父类加载器为 <code>AppClassLoader</code> ，下面我们通过代码来验证上述的观点。</li></ul></li></ul><figure class="highlight java"><figcaption data-lang="java"><span>CustomClassLoader.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token operator">*</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Files</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="8"></td><td><pre> * @Description: 自定义类加载器</pre></td></tr><tr><td data-num="9"></td><td><pre> * @DateTime: 2023-12-02 15:22</pre></td></tr><tr><td data-num="10"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="11"></td><td><pre> **/</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   * 文件扩展名</pre></td></tr><tr><td data-num="15"></td><td><pre>   */</pre></td></tr><tr><td data-num="16"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> FILE_EXTENSION <span class="token operator">=</span> <span class="token string">".class"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   * .class 文件路径</pre></td></tr><tr><td data-num="19"></td><td><pre>   */</pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> filePath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="23"></td><td><pre>   * 构造方法</pre></td></tr><tr><td data-num="24"></td><td><pre>   *</pre></td></tr><tr><td data-num="25"></td><td><pre>   * @param filePath .class 文件路径</pre></td></tr><tr><td data-num="26"></td><td><pre>   */</pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token keyword">public</span> <span class="token class-name">CustomClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">this</span><span class="token punctuation">.</span>filePath <span class="token operator">=</span> filePath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="30"></td><td><pre></pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="32"></td><td><pre>   * 重写获取类的字节码并创建 class 对象的逻辑</pre></td></tr><tr><td data-num="33"></td><td><pre>   *</pre></td></tr><tr><td data-num="34"></td><td><pre>   * @param className 全限定类名称</pre></td></tr><tr><td data-num="35"></td><td><pre>   * @return Class&lt;?> 任意 class 类型对象</pre></td></tr><tr><td data-num="36"></td><td><pre>   */</pre></td></tr><tr><td data-num="37"></td><td><pre>  <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="38"></td><td><pre>  <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>    <span class="token comment">// 获取字节码的字节数组</span></pre></td></tr><tr><td data-num="40"></td><td><pre>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClassData</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    <span class="token comment">// 调用父类中的 defineClass 方法将字节流解析成 JVM 能够识别的 Class 对象并返回</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="44"></td><td><pre></pre></td></tr><tr><td data-num="45"></td><td><pre>  <span class="token comment">/**</span></pre></td></tr><tr><td data-num="46"></td><td><pre>   * 读取字节码流的方法</pre></td></tr><tr><td data-num="47"></td><td><pre>   *</pre></td></tr><tr><td data-num="48"></td><td><pre>   * @param className 对象全限定名称</pre></td></tr><tr><td data-num="49"></td><td><pre>   * @return byte [] 字节数组</pre></td></tr><tr><td data-num="50"></td><td><pre>   */</pre></td></tr><tr><td data-num="51"></td><td><pre>  <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getClassData</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token comment">// 创建 InputStream 对象获取字节输入流</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>    <span class="token comment">// 定义一个字节数组</span></pre></td></tr><tr><td data-num="55"></td><td><pre>    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token comment">// 创建 ByteArrayOutputStream 获取字节输出流</span></pre></td></tr><tr><td data-num="57"></td><td><pre>    <span class="token class-name">ByteArrayOutputStream</span> byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>      <span class="token comment">// 将字符串中的 "." 全部替换为 “\\”</span></pre></td></tr><tr><td data-num="60"></td><td><pre>      <span class="token comment">// 获取全限定名称类路径如：top.rem.rain.NotEqualClassTest -> top\rem\rain\NotEqualClassTest</span></pre></td></tr><tr><td data-num="61"></td><td><pre>      className <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>      <span class="token comment">// 读取.class 文件到 InputStream 流中</span></pre></td></tr><tr><td data-num="63"></td><td><pre>      inputStream <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">newInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> className <span class="token operator">+</span> FILE_EXTENSION<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>      <span class="token comment">//new ByteArrayOutputStream 获取字节输出流对象</span></pre></td></tr><tr><td data-num="65"></td><td><pre>      byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>      <span class="token keyword">int</span> ch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>      <span class="token comment">//inputStream 字节流读取到 - 1 为结束</span></pre></td></tr><tr><td data-num="68"></td><td><pre>      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>ch <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>        <span class="token comment">// 将字节乳流中的数据写入到字节输出流中 inputStream -> byteArrayOutputStream</span></pre></td></tr><tr><td data-num="70"></td><td><pre>        byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>      <span class="token comment">// 将字节输出流转换为字节数组并赋值到 data 中</span></pre></td></tr><tr><td data-num="73"></td><td><pre>      data <span class="token operator">=</span> byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>      e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>    <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>      <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">assert</span> inputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        <span class="token keyword">assert</span> byteArrayOutputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>      <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>      <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>    <span class="token keyword">return</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>CustomClassLoaderTest.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="5"></td><td><pre> * @Description: 自定义加载器测试类</pre></td></tr><tr><td data-num="6"></td><td><pre> * @DateTime: 2023-12-02 15:32</pre></td></tr><tr><td data-num="7"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="8"></td><td><pre> **/</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomClassLoaderTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">CustomClassLoader</span> loader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomClassLoader</span><span class="token punctuation">(</span><span class="token class-name">CustomClassLoaderTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"自定义类加载器的父加载器: "</span><span class="token operator">+</span>loader<span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"系统默认的AppClassLoader: "</span><span class="token operator">+</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"AppClassLoader的父类加载器: "</span><span class="token operator">+</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"ExtClassLoader的父类加载器: "</span><span class="token operator">+</span><span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="19"></td><td><pre>          执行结果：</pre></td></tr><tr><td data-num="20"></td><td><pre>            自定义类加载器的父加载器: sun.misc.Launcher$AppClassLoader@18b4aac2</pre></td></tr><tr><td data-num="21"></td><td><pre>            系统默认的 AppClassLoader: sun.misc.Launcher$AppClassLoader@18b4aac2</pre></td></tr><tr><td data-num="22"></td><td><pre>            AppClassLoader 的父类加载器: sun.misc.Launcher$ExtClassLoader@4554617c</pre></td></tr><tr><td data-num="23"></td><td><pre>            ExtClassLoader 的父类加载器: null</pre></td></tr><tr><td data-num="24"></td><td><pre>         */</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>在上述代码中我们自定义了一个 <code>CustomClassLoader</code> 并继承了 <code>ClassLoader</code> 类，而非继承自 <code>URLClassLoader</code> 。</li><li>因此需要自己编写 <code>findClass()</code> 方法的逻辑以及加载字节码逻辑，在这里我们仅需要知道 <code>CustomClassLoader</code> 是自定义加载器即可。</li><li>接着在 <code>main</code> 方法之后通过 <code>ClassLoader.getSystemClassLoader()</code> 方法获取到系统默认类加载器，通过获取其父类加载器及父类的父类加载器，同时还获取了自定义类加载器的父类加载器，打印结果正如我们所预料的。</li><li><code>AppClassLoader</code> 的父类加载器为 <code>ExtClassLoader</code> ，而 <code>ExtClassLoader</code> 并没有父类加载器。</li><li>自定义类加载器默认情况下它的父类加载器都是 <code>AppClassLoader</code> ，我们来看 <code>Lancher</code> 构造器的源码。</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>Launcher.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlOHUyMTEtbGF0ZXItYXJjaGl2ZS1kb3dubG9hZHMuaHRtbA==">参考JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">sun<span class="token punctuation">.</span>misc</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Launcher</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Launcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token comment">// Create the extension class loader -> 创建扩展类加载器</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token class-name">ClassLoader</span> extcl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            extcl <span class="token operator">=</span> <span class="token class-name">ExtClassLoader</span><span class="token punctuation">.</span><span class="token function">getExtClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token comment">// 无法创建扩展类加载器将抛出此异常</span></pre></td></tr><tr><td data-num="12"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="13"></td><td><pre>                <span class="token string">"Could not create extension class loader"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        </pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// Now create the class loader to use to launch the application -> 现在创建用于启动应用程序的类加载器</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>            <span class="token comment">// 在创建 AppClassLoader 时并把 extcl 作为父类加载器传递给 AppClassLoader</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            loader <span class="token operator">=</span> <span class="token class-name">AppClassLoader</span><span class="token punctuation">.</span><span class="token function">getAppClassLoader</span><span class="token punctuation">(</span>extcl<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token string">"Could not create application class loader"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token comment">// 设置线程上下文类加载器，后面分析</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token comment">// Also set the context class loader for the primordial thread -> 还要为原始线程设置上下文类加载器</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setContextClassLoader</span><span class="token punctuation">(</span>loader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// Finally, install a security manager if requested -> 最后如果需要安装安全管理器</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"java.security.manager"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>            <span class="token comment">//init FileSystem machinery before SecurityManager installation -> 安装 SecurityManager 之前的 init 文件系统机制</span></pre></td></tr><tr><td data-num="32"></td><td><pre>            <span class="token class-name"><span class="token namespace">sun<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>fs<span class="token punctuation">.</span></span>DefaultFileSystemProvider</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token class-name">SecurityManager</span> sm <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">"default"</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                sm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>SecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                    sm <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">SecurityManager</span><span class="token punctuation">)</span>loader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IllegalAccessException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InstantiationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ClassCastException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>sm <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">setSecurityManager</span><span class="token punctuation">(</span>sm<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                    <span class="token string">"Could not create SecurityManager: "</span> <span class="token operator">+</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>在 <code>Lancher</code> 初始化时首先会创建 <code>ExtClassLoader</code> 类加载器，然后再创建 <code>AppClassLoader</code> 并把 <code>ExtClassLoader</code> 传递给 <code>AppClassLoader</code> 作为父类加载器。</li><li>后面还把 <code>AppClassLoader</code> 默认设置为线程上下文加载器，关于线程上下文类加载器后面分析。</li><li>最后就是 <code>ExtClassLoader</code> 类加载器为什么是 <code>null</code> ??? 来看下面的源码中的创建过程就会明白了。</li><li>在创建 <code>ExtClassLoader</code> 时强制设置了其父类加载器为 <code>null</code> 。</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>Launcher.java </span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlOHUyMTEtbGF0ZXItYXJjaGl2ZS1kb3dubG9hZHMuaHRtbA==">参考JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">sun<span class="token punctuation">.</span>misc</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Launcher</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Launcher</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">ClassLoader</span> extcl<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>            <span class="token comment">// 1. 创建 ExtClassLoader</span></pre></td></tr><tr><td data-num="9"></td><td><pre>            extcl <span class="token operator">=</span> <span class="token class-name">ExtClassLoader</span><span class="token punctuation">.</span><span class="token function">getExtClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">InternalError</span><span class="token punctuation">(</span><span class="token string">"Could not create extension class loader"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 省略此处其它没必要的代码...</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/*</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * ExtClassLoader 继承自 URLClassLoader</pre></td></tr><tr><td data-num="18"></td><td><pre>     * 用于加载已安装扩展的类加载器</pre></td></tr><tr><td data-num="19"></td><td><pre>     * The class loader used for loading installed extensions.</pre></td></tr><tr><td data-num="20"></td><td><pre>     */</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">ExtClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">URLClassLoader</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 省略此处其它没必要的代码...</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ExtClassLoader</span> <span class="token function">getExtClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>                <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">ExtClassLoader</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>                        <span class="token comment">// 2. 继续跟踪 createExtClassLoader 方法</span></pre></td></tr><tr><td data-num="30"></td><td><pre>                        instance <span class="token operator">=</span> <span class="token function">createExtClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>            <span class="token comment">// 5. 然后返回出来的 ExtClassLoader 类中的父加载器就是 null</span></pre></td></tr><tr><td data-num="35"></td><td><pre>            <span class="token keyword">return</span> instance<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">ExtClassLoader</span> <span class="token function">createExtClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>                <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                        <span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ExtClassLoader</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                            <span class="token keyword">public</span> <span class="token class-name">ExtClassLoader</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                                <span class="token keyword">final</span> <span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dirs <span class="token operator">=</span> <span class="token function">getExtDirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                                <span class="token keyword">int</span> len <span class="token operator">=</span> dirs<span class="token punctuation">.</span>length<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                                    <span class="token class-name">MetaIndex</span><span class="token punctuation">.</span><span class="token function">registerDirectory</span><span class="token punctuation">(</span>dirs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                                <span class="token comment">// 3. 此处返回创建了一个 ExtClassLoader 对象，继续跟踪</span></pre></td></tr><tr><td data-num="49"></td><td><pre>                                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ExtClassLoader</span><span class="token punctuation">(</span>dirs<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>                            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span>PrivilegedActionException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                <span class="token keyword">throw</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span><span class="token punctuation">)</span> e<span class="token punctuation">.</span><span class="token function">getException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="56"></td><td><pre></pre></td></tr><tr><td data-num="57"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="58"></td><td><pre>         * 为指定的目录创建一个新的 ExtClassLoader。</pre></td></tr><tr><td data-num="59"></td><td><pre>         * Creates a new ExtClassLoader for the specified directories.</pre></td></tr><tr><td data-num="60"></td><td><pre>         */</pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token keyword">public</span> <span class="token class-name">ExtClassLoader</span><span class="token punctuation">(</span><span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dirs<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>            <span class="token comment">// 4. 此处调用父类构造 URLClassLoader 传递 null 作为 parent</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token function">getExtURLs</span><span class="token punctuation">(</span>dirs<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token class-name">SharedSecrets</span><span class="token punctuation">.</span><span class="token function">getJavaNetAccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span></pre></td></tr><tr><td data-num="65"></td><td><pre>                    <span class="token function">getURLClassPath</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">initLookupCache</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="68"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>上述 <code>super</code> 跟入进去后便是下面的 <code>URLClassLoader</code> 构造器源码。</p></blockquote><figure class="highlight java"><figcaption data-lang="java"><span>URLClassLoader.java </span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlOHUyMTEtbGF0ZXItYXJjaGl2ZS1kb3dubG9hZHMuaHRtbA==">参考JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">URLClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">SecureClassLoader</span> <span class="token keyword">implements</span> <span class="token class-name">Closeable</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    </pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">URLClassLoader</span><span class="token punctuation">(</span>URL<span class="token punctuation">[</span><span class="token punctuation">]</span> urls<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="6"></td><td><pre>                          <span class="token class-name">URLStreamHandlerFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token comment">// this is to make the stack depth consistent with 1.1</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token class-name">SecurityManager</span> security <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getSecurityManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>security <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>            security<span class="token punctuation">.</span><span class="token function">checkCreateClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        acc <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">getContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        ucp <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLClassPath</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> factory<span class="token punctuation">,</span> acc<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>仔细分析后很显然 <code>ExtClassLoaer</code> 的父类为 <code>null</code> ，而 <code>AppClassLoader</code> 的父加载器为 <code>ExtClassLoader</code> 。</li><li>所有自定义类加载器默认情况下其父加载器都是 <code>AppClassLoader</code> ，<span class="red">注意：</span>这里所指的父类加载器并不是 <code>Java</code> 继承关系中的那种父子关系。</li></ul><h1 id="类与类加载器"><a class="anchor" href="#类与类加载器">#</a> 类与类加载器</h1><ul><li>在 <code>JVM</code> 中表示两个 <code>class</code> 对象是否为同一个类对象时，存在两个必要条件：<ul><li>类的全限定名称需要保持一致。</li><li>加载这个类的 <code>ClassLoader</code> 实例对象必须相同。</li></ul></li><li>就是说在 <code>JVM</code> 中即使这两个类对象 ( <code>class</code> 对象) 来源于同一个 <code>Class</code> 文件，被同一个虚拟机所加载，但只要加载它们的 <code>ClassLoader</code> 实例对象不同，那么这两个类对象也是不相等的。</li><li>这是因为不同的 <code>ClassLoader</code> 实例对象都拥有不同的独立类名空间，所以加载的 <code>class</code> 对象也会存在不同的类名空间中，<span class="red">注意：前提是需要重写 <code>loadClass()</code> 方法</span>。</li><li>就从前面的 <code>双亲委派模式</code> 对 <code>loadClass()</code> 方法源码分析中可得知，在方法第一步会通过 <code>Class&lt;?&gt; c = findLoadedClass(name)</code> 从缓存中查找，类的完全限定名相同则不会再一次被加载。</li><li>因此我们必须绕过缓存查询才能重新加载 <code>class</code> 对象，也可以直接调用 <code>findClass()</code> 方法，下面是避免从缓存中查找的代码示例如下。</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>NotEqualClassTest.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="5"></td><td><pre> * @Description: 不相等对象测试</pre></td></tr><tr><td data-num="6"></td><td><pre> * @DateTime: 2023-12-02 22:11</pre></td></tr><tr><td data-num="7"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="8"></td><td><pre> **/</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NotEqualClassTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token comment">// 此处是.class 文件存在的项目的顶级目录路径</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token class-name">String</span> classPath <span class="token operator">=</span> <span class="token string">"D:\\项目\\gitee\\untitled\\out\\production\\untitled\\"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token comment">// 创建两个不同的自定义类加载器</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">CustomClassLoader</span> classLoader1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomClassLoader</span><span class="token punctuation">(</span>classPath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">CustomClassLoader</span> classLoader2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomClassLoader</span><span class="token punctuation">(</span>classPath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 通过 findClass 创建类的 Class 对象</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass1 <span class="token operator">=</span> classLoader1<span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span><span class="token string">"top.rem.rain.NotEqualClassTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass2 <span class="token operator">=</span> classLoader2<span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span><span class="token string">"top.rem.rain.NotEqualClassTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"findClass -> aClass1:"</span><span class="token operator">+</span>aClass1<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"findClass -> aClass2:"</span><span class="token operator">+</span>aClass2<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        </pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="23"></td><td><pre>          执行结果：</pre></td></tr><tr><td data-num="24"></td><td><pre>            findClass -> aClass1:1836019240</pre></td></tr><tr><td data-num="25"></td><td><pre>            findClass -> aClass2:325040804</pre></td></tr><tr><td data-num="26"></td><td><pre>            生成不同实例对象</pre></td></tr><tr><td data-num="27"></td><td><pre>         */</pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>如果调用父类的 <code>loadClass()</code> 方法，结果如下，除非重写 <code>loadClass()</code> 方法去掉缓存查找步骤，不过现在一般都不建议重写 <code>loadClass()</code> 方法。</p></blockquote><figure class="highlight java"><figcaption data-lang="java"><span>EqualClassTest.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="5"></td><td><pre> * @Description: 相等对象测试</pre></td></tr><tr><td data-num="6"></td><td><pre> * @DateTime: 2023-12-03 00:55</pre></td></tr><tr><td data-num="7"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="8"></td><td><pre> **/</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EqualClassTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token comment">// 此处是.class 文件存在的项目的顶级目录路径</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token class-name">String</span> classPath <span class="token operator">=</span> <span class="token string">"D:\\项目\\gitee\\untitled\\out\\production\\untitled\\"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token comment">// 创建两个不同的自定义类加载器</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token class-name">CustomClassLoader</span> classLoader1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomClassLoader</span><span class="token punctuation">(</span>classPath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">CustomClassLoader</span> classLoader2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CustomClassLoader</span><span class="token punctuation">(</span>classPath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 直接调用 loadClass 方法的输出结果，注意并没有重写 loadClass 方法</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass1 <span class="token operator">=</span> classLoader1<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"top.rem.rain.EqualClassTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass2 <span class="token operator">=</span> classLoader2<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"top.rem.rain.EqualClassTest"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"findClass -> aClass1:"</span> <span class="token operator">+</span> aClass1<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"findClass -> aClass2:"</span> <span class="token operator">+</span> aClass2<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Class -> aClass3:"</span> <span class="token operator">+</span> <span class="token class-name">EqualClassTest</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="24"></td><td><pre>          直接调用 loadClass 方法的输出结果，注意并没有重写 loadClass 方法</pre></td></tr><tr><td data-num="25"></td><td><pre>          执行结果：</pre></td></tr><tr><td data-num="26"></td><td><pre>          findClass -> aClass1:685325104</pre></td></tr><tr><td data-num="27"></td><td><pre>          findClass -> aClass2:685325104</pre></td></tr><tr><td data-num="28"></td><td><pre>          Class -> aClass3:685325104</pre></td></tr><tr><td data-num="29"></td><td><pre>          生成的都是同一个实例对象</pre></td></tr><tr><td data-num="30"></td><td><pre>         */</pre></td></tr><tr><td data-num="31"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>所以如果不想从缓存查询相同完全类名的 <code>class</code> 对象，那么只有 <code>ClassLoader</code> 的实例对象不同，同一个字节码文件创建的 <code>class</code> 对象自然也不会相同。</p></blockquote><h1 id="class文件显示隐式加载概念"><a class="anchor" href="#class文件显示隐式加载概念">#</a> class 文件显示 &amp; 隐式加载概念</h1><p><span class="label">了解</span></p><ul><li>所谓的 <code>class</code> 文件的显示加载与隐式加载的方式是指 <code>JVM</code> 加载 <code>class</code> 文件到内存中的方式。</li><li>显示加载指的是在代码中通过调用 <code>ClassLoader</code> 加载 <code>class</code> 对象，如直接调用 <code>Class.forName(name)</code> 或 <code>this.getClass().getClassLoader().loadClass()</code> 加载 <code>class</code> 对象。</li><li>隐式加载指的是不直接在代码中调用 <code>ClassLoader</code> 方法加载 <code>class</code> 对象，而是通过虚拟机自动加载到内存中，如在加载某个类的 <code>class</code> 文件时，该类的 <code>class</code> 文件中引用了另外一个类对象，此时额外引用的类将通过 <code>JVM</code> 自动加载到内存中。</li><li>以上两种方式一般会混合使用。</li></ul><h1 id="实现自定义类加载器"><a class="anchor" href="#实现自定义类加载器">#</a> 实现自定义类加载器</h1><ul><li>想实现自定义类加载器需要继承 <code>ClassLoader</code> 或者 <code>URLClassLoader</code> 类。</li><li>继承 <code>ClassLoader</code> 则需要自己重写 <code>findClass()</code> 方法并编写加载逻辑。</li><li>继承 <code>URLClassLoader</code> 则不用自己编写 <code>findClass()</code> 方法的加载逻辑以及 <code>class</code> 文件加载转换成字节码流的代码。</li><li><span class="red">为什么要编写自定义类加载器其意义何在？</span><ul><li>当 <code>class</code> 文件不在 <code>ClassPath</code> 路径下，默认系统类加载器 (应用类加载器) 无法找到该 <code>class</code> 文件，在这种情况下我们需要自己实现一个自定义的 <code>ClassLoader</code> 来加载特定路径下的 <code>class</code> 文件生成 <code>class</code> 对象。</li><li>当一个 <code>class</code> 文件是通过网络传输并且可能会进行相应加密操作时，需要先对 <code>class</code> 文件进行相应的解密后再加载到 <code>JVM</code> 内存中，这种情况下也需要自己编写自定义的 <code>ClassLoader</code> 并实现相应的逻辑。</li><li>当需要实现热部署功能时 (一个 <code>class</code> 文件通过不同的类加载器产生不同 <code>class</code> 对象从而实现热部署功能) 也想要自己实现自定义 <code>ClassLoader</code> 的逻辑。</li></ul></li></ul><h1 id="自定义file类加载器"><a class="anchor" href="#自定义file类加载器">#</a> 自定义 File 类加载器</h1><div class="note info no-icon"><p>我们继承 <code>ClassLoader</code> 实现自定义的特定路径下的文件类加载器并加载编译后的 <code>Student.class</code> 源码如下。</p></div><figure class="highlight java"><figcaption data-lang="java"><span>Student.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="5"></td><td><pre> * @Description: 学生类对象</pre></td></tr><tr><td data-num="6"></td><td><pre> * @DateTime: 2023-12-03 12:42</pre></td></tr><tr><td data-num="7"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="8"></td><td><pre> **/</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Student</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">"top.rem.rain.Student&#123; "</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="13"></td><td><pre>            <span class="token string">"name="</span> <span class="token operator">+</span> <span class="token string">"LightRain"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="14"></td><td><pre>            <span class="token string">" age="</span> <span class="token operator">+</span> <span class="token string">"17"</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="15"></td><td><pre>            <span class="token string">" sex="</span> <span class="token operator">+</span> <span class="token string">"woman "</span> <span class="token operator">+</span></pre></td></tr><tr><td data-num="16"></td><td><pre>            <span class="token string">'&#125;'</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>FileClassLoader.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>file<span class="token punctuation">.</span></span><span class="token class-name">Files</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="10"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="11"></td><td><pre> * @Description: 自定义 FileClassLoader</pre></td></tr><tr><td data-num="12"></td><td><pre> * @DateTime: 2023-12-03 12:50</pre></td></tr><tr><td data-num="13"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="14"></td><td><pre> **/</pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="17"></td><td><pre>     * 文件扩展名</pre></td></tr><tr><td data-num="18"></td><td><pre>     */</pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token class-name">String</span> FILE_EXTENSION <span class="token operator">=</span> <span class="token string">".class"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="21"></td><td><pre>     * .class 文件路径</pre></td></tr><tr><td data-num="22"></td><td><pre>     */</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> filePath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">FileClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>filePath <span class="token operator">=</span> filePath<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>        <span class="token comment">// 获取字节码的字节数组</span></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClassData</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>        <span class="token comment">// 调用父类中的 defineClass 方法将字节流解析成 JVM 能够识别的 Class 对象并返回</span></pre></td></tr><tr><td data-num="34"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">defineClass</span><span class="token punctuation">(</span>className<span class="token punctuation">,</span> data<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="38"></td><td><pre>     * 读取字节码流的方法</pre></td></tr><tr><td data-num="39"></td><td><pre>     *</pre></td></tr><tr><td data-num="40"></td><td><pre>     * @param className 对象全限定名称</pre></td></tr><tr><td data-num="41"></td><td><pre>     * @return byte [] 字节数组</pre></td></tr><tr><td data-num="42"></td><td><pre>     */</pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getClassData</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token comment">// 创建 InputStream 对象获取字节输入流</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        <span class="token class-name">InputStream</span> inputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token comment">// 定义一个字节数组</span></pre></td></tr><tr><td data-num="47"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> data <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>        <span class="token comment">// 创建 ByteArrayOutputStream 获取字节输出流</span></pre></td></tr><tr><td data-num="49"></td><td><pre>        <span class="token class-name">ByteArrayOutputStream</span> byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token comment">// 将字符串中的 "." 全部替换为 “\\”</span></pre></td></tr><tr><td data-num="52"></td><td><pre>            <span class="token comment">// 获取全限定名称类路径如：top.rem.rain.NotEqualClassTest -> top\rem\rain\NotEqualClassTest</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            className <span class="token operator">=</span> className<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>            <span class="token comment">// 读取.class 文件到 InputStream 流中</span></pre></td></tr><tr><td data-num="55"></td><td><pre>            inputStream <span class="token operator">=</span> <span class="token class-name">Files</span><span class="token punctuation">.</span><span class="token function">newInputStream</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath <span class="token operator">+</span> className <span class="token operator">+</span> FILE_EXTENSION<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>            <span class="token comment">//new ByteArrayOutputStream 获取字节输出流对象</span></pre></td></tr><tr><td data-num="57"></td><td><pre>            byteArrayOutputStream <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token keyword">int</span> ch <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>            <span class="token comment">//inputStream 字节流读取到 - 1 为结束</span></pre></td></tr><tr><td data-num="60"></td><td><pre>            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>ch <span class="token operator">=</span> inputStream<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>                <span class="token comment">// 将字节乳流中的数据写入到字节输出流中 inputStream -> byteArrayOutputStream</span></pre></td></tr><tr><td data-num="62"></td><td><pre>                byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>ch<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token comment">// 将字节输出流转换为字节数组并赋值到 data 中</span></pre></td></tr><tr><td data-num="65"></td><td><pre>            data <span class="token operator">=</span> byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">finally</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token keyword">assert</span> inputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                inputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                <span class="token keyword">assert</span> byteArrayOutputStream <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>                byteArrayOutputStream<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        <span class="token keyword">return</span> data<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="80"></td><td><pre></pre></td></tr><tr><td data-num="81"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>FileClassLoaderTest.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="5"></td><td><pre> * @Description: FileClassLoader 测试</pre></td></tr><tr><td data-num="6"></td><td><pre> * @DateTime: 2023-12-03 12:56</pre></td></tr><tr><td data-num="7"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="8"></td><td><pre> **/</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileClassLoaderTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">String</span> filePath  <span class="token operator">=</span> <span class="token string">"D:\\项目\\gitee\\untitled\\out\\production\\untitled\\"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 创建自定义文件类加载器</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">FileClassLoader</span> fileClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileClassLoader</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token comment">// 加载指定的 class 文件</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass <span class="token operator">=</span> fileClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"top.rem.rain.Student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aClass.newInstance().toString() = "</span> <span class="token operator">+</span> aClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="18"></td><td><pre>          执行结果：aClass.newInstance ().toString () = top.rem.rain.Student &#123; name=LightRain age=17 sex=woman &#125;</pre></td></tr><tr><td data-num="19"></td><td><pre>         */</pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>我们通过 <code>getClassData()</code> 方法找到了 <code>class</code> 文件并转换为字节流重写了 <code>findClass()</code> 方法，利用 <code>defineClass()</code> 方法创建了类的 <code>class</code> 对象。</li><li>在 <code>main</code> 方法中调用 <code>loadClass()</code> 方法加载指定路径下的 <code>class</code> 文件，由于启动类加载器、扩展类加载器以及系统类加载器都无法在其路径下找到该类，因此最终将由自定义类加载器加载，即调用 <code>findClass()</code> 方法进行加载。</li></ul><div class="note info no-icon"><p>如果继承 <code>URLClassLoader</code> 类来实现自定义类加载器，代码将会更加简洁，代码如下。</p></div><figure class="highlight java"><figcaption data-lang="java"><span>FileUrlClassLoader.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLClassLoader</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">URLStreamHandlerFactory</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="9"></td><td><pre> * @Description: 继承自 URLClassLoader 的自定义类加载器</pre></td></tr><tr><td data-num="10"></td><td><pre> * @DateTime: 2023-12-03 14:37</pre></td></tr><tr><td data-num="11"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="12"></td><td><pre> **/</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUrlClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">URLClassLoader</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">FileUrlClassLoader</span><span class="token punctuation">(</span>URL<span class="token punctuation">[</span><span class="token punctuation">]</span> urls<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">FileUrlClassLoader</span><span class="token punctuation">(</span>URL<span class="token punctuation">[</span><span class="token punctuation">]</span> urls<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">FileUrlClassLoader</span><span class="token punctuation">(</span>URL<span class="token punctuation">[</span><span class="token punctuation">]</span> urls<span class="token punctuation">,</span> <span class="token class-name">ClassLoader</span> parent<span class="token punctuation">,</span> <span class="token class-name">URLStreamHandlerFactory</span> factory<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token keyword">super</span><span class="token punctuation">(</span>urls<span class="token punctuation">,</span> parent<span class="token punctuation">,</span> factory<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><figure class="highlight java"><figcaption data-lang="java"><span>FileUrlClassLoaderTest.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span><span class="token class-name">MalformedURLException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="9"></td><td><pre> * @Description: FileUrlClassLoader 测试</pre></td></tr><tr><td data-num="10"></td><td><pre> * @DateTime: 2023-12-03 14:38</pre></td></tr><tr><td data-num="11"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="12"></td><td><pre> **/</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileUrlClassLoaderTest</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MalformedURLException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">,</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token class-name">String</span> filePath  <span class="token operator">=</span> <span class="token string">"D:\\项目\\gitee\\untitled\\out\\production\\untitled\\"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token comment">// 创建自定义文件类加载器</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">FileUrlClassLoader</span> fileUrlClassLoader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileUrlClassLoader</span><span class="token punctuation">(</span><span class="token keyword">new</span> URL<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">&#123;</span>file<span class="token punctuation">.</span><span class="token function">toURI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toURL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>        <span class="token comment">// 加载指定的 class 文件</span></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass <span class="token operator">=</span> fileUrlClassLoader<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"top.rem.rain.Student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"aClass.newInstance().toString() = "</span> <span class="token operator">+</span> aClass<span class="token punctuation">.</span><span class="token function">newInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        </pre></td></tr><tr><td data-num="24"></td><td><pre>         <span class="token comment">/*</span></pre></td></tr><tr><td data-num="25"></td><td><pre>          执行结果：aClass.newInstance ().toString () = top.rem.rain.Student &#123; name=LightRain age=17 sex=woman &#125;</pre></td></tr><tr><td data-num="26"></td><td><pre>         */</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>除了需要重写构造器外无需编写 <code>findClass()</code> 方法及其 <code>class</code> 文件字节码流的转换逻辑。</p></blockquote><h1 id="自定义网络类加载器"><a class="anchor" href="#自定义网络类加载器">#</a> 自定义网络类加载器</h1><div class="note info no-icon"><p>自定义网络类加载器，主要用于读取通过网络传递的 <code>class</code> 文件</p></div><figure class="highlight java"><figcaption data-lang="java"><span>NetClassLoader.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">InputStream</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net<span class="token punctuation">.</span></span>URL<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="8"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="9"></td><td><pre> * @Description: 自定义网络类加载器</pre></td></tr><tr><td data-num="10"></td><td><pre> * @DateTime: 2023-12-03 15:43</pre></td></tr><tr><td data-num="11"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="12"></td><td><pre> **/</pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">NetClassLoader</span> <span class="token keyword">extends</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> url<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">NetClassLoader</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token keyword">this</span><span class="token punctuation">.</span>url <span class="token operator">=</span> url<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token annotation punctuation">@Override</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">protected</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> <span class="token function">findClass</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classData <span class="token operator">=</span> <span class="token function">getClassDataFromNet</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>classData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ClassNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>            <span class="token keyword">return</span> <span class="token function">defineClass</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> classData<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> classData<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="29"></td><td><pre></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="31"></td><td><pre>     * 从网络获取 class 文件</pre></td></tr><tr><td data-num="32"></td><td><pre>     * @param className</pre></td></tr><tr><td data-num="33"></td><td><pre>     * @return</pre></td></tr><tr><td data-num="34"></td><td><pre>     */</pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">getClassDataFromNet</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token function">classNameToPath</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>            <span class="token class-name">URL</span> url <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token function">URL</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre>            <span class="token class-name">ByteArrayOutputStream</span> baos<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="40"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> ins <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">openStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>                baos <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ByteArrayOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>                <span class="token keyword">int</span> bufferSize <span class="token operator">=</span> <span class="token number">4096</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>                <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span>bufferSize<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>                <span class="token keyword">int</span> bytesNumRead <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>                <span class="token comment">// 读取类文件的字节</span></pre></td></tr><tr><td data-num="46"></td><td><pre>                <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>bytesNumRead <span class="token operator">=</span> ins<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>                    baos<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> bytesNumRead<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>            <span class="token comment">// 如果有加密操作需要在这里先进行解密</span></pre></td></tr><tr><td data-num="51"></td><td><pre>            <span class="token keyword">return</span> baos<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">classNameToPath</span><span class="token punctuation">(</span><span class="token class-name">String</span> className<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token comment">// 得到类文件的 URL</span></pre></td></tr><tr><td data-num="60"></td><td><pre>        <span class="token keyword">return</span> url <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> className<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">".class"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>主要是在获取字节码流时的区别，从网络直接获取到字节流再转成字节数组然后利用 <code>defineClass()</code> 方法创建 <code>class</code> 对象。</li><li>如果继承自 <code>URLClassLoader</code> 类则和前面文件路径的实现是类似的，无需担心路径是 <code>filePath</code> 还是 <code>url</code> ，因为 <code>URLClassLoader</code> 内的 <code>URLClassPath</code> 对象会根据传递过来的 <code>URL</code> 数组中的路径去判断是文件还是 <code>jar</code> 包，然后根据不同的路径创建 <code>FileLoader</code> 或 <code>JarLoader</code> 或默认类 <code>Loader</code> 去读取对应的路径或 <code>url</code> 下的 <code>class</code> 文件。</li></ul><h1 id="实现热部署类加载器"><a class="anchor" href="#实现热部署类加载器">#</a> 实现热部署类加载器</h1><ul><li>热部署就是利用同一个 <code>class</code> 文件，使用不同的类加载器在内存中创建出两个不同的 <code>class</code> 对象 (即使用不同的类加载器加载实例)，由于 <code>JVM</code> 在加载类之前会检测请求的类是否已被加载过 (即在 <code>loadClass()</code> 方法中调用 <code>findLoadedClass()</code> 方法)。</li><li>如果被加载过则直接从缓存获取，不会重新再加载， <code>注意：</code> 同一个类加载器的实例和同一个 <code>class</code> 文件只能被加载器加载一次，多次加载将会报错。</li><li>因此我们实现热部署必须让同一个 <code>class</code> 文件，可以根据不同的类加载器重复加载，以实现所谓的热部署。</li><li>实际上前面实现的 <code>FileClassLoader</code> 和 <code>FileUrlClassLoader</code> 已具备这个功能了，但前提是直接调用 <code>findClass()</code> 方法，而不是调用 <code>loadClass()</code> 方法，因为我们重写了 <code>findClass()</code> 方法，在方法中我们并没有去查询缓存中是否已被加载。</li><li>因此在 <code>ClassLoader</code> 中的 <code>loadClass()</code> 方法体中调用的 <code>findLoadedClass()</code> 方法进行了检测是否已被加载。</li><li>因此我们直接调用 <code>findClass()</code> 方法就可以绕过这个问题，当然也可以重写 <code>loadClass()</code> ，只不过是不推荐这么干仅此而已。</li><li>利用 <code>FileClassLoader</code> 类测试代码如下：</li></ul><figure class="highlight java"><figcaption data-lang="java"><span>FileClassLoaderTest2.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="4"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="5"></td><td><pre> * @Description: FileClassLoader 测试 -- 热部署</pre></td></tr><tr><td data-num="6"></td><td><pre> * @DateTime: 2023-12-03 12:56</pre></td></tr><tr><td data-num="7"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="8"></td><td><pre> **/</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FileClassLoaderTest2</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InstantiationException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalAccessException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token class-name">String</span> filePath  <span class="token operator">=</span> <span class="token string">"D:\\项目\\gitee\\untitled\\out\\production\\untitled\\"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token comment">// 创建自定义文件类加载器</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token class-name">FileClassLoader</span> fileClassLoader1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileClassLoader</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>        <span class="token class-name">FileClassLoader</span> fileClassLoader2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileClassLoader</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token comment">// 加载指定的 class 文件，调用 loadClass ()</span></pre></td></tr><tr><td data-num="16"></td><td><pre>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass1 <span class="token operator">=</span> fileClassLoader1<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"top.rem.rain.Student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass2 <span class="token operator">=</span> fileClassLoader2<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">"top.rem.rain.Student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"loadClass -> aClass1:"</span><span class="token operator">+</span>aClass1<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"loadClass -> aClass2:"</span><span class="token operator">+</span>aClass2<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--------------------------------"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token comment">// 加载指定的 class 文件，直接调用 findClass (), 绕过检测机制，创建不同 class 对象。</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass3 <span class="token operator">=</span> fileClassLoader1<span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span><span class="token string">"top.rem.rain.Student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">></span></span> aClass4 <span class="token operator">=</span> fileClassLoader2<span class="token punctuation">.</span><span class="token function">findClass</span><span class="token punctuation">(</span><span class="token string">"top.rem.rain.Student"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"findClass -> aClass3:"</span><span class="token operator">+</span>aClass3<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"findClass -> aClass4:"</span><span class="token operator">+</span>aClass4<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        </pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">/*</span></pre></td></tr><tr><td data-num="30"></td><td><pre>          执行结果：</pre></td></tr><tr><td data-num="31"></td><td><pre>            loadClass -> aClass1:1163157884</pre></td></tr><tr><td data-num="32"></td><td><pre>            loadClass -> aClass2:1163157884</pre></td></tr><tr><td data-num="33"></td><td><pre>            --------------------------------</pre></td></tr><tr><td data-num="34"></td><td><pre>            findClass -> aClass3:325040804</pre></td></tr><tr><td data-num="35"></td><td><pre>            findClass -> aClass4:1173230247</pre></td></tr><tr><td data-num="36"></td><td><pre>         */</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="线程上下文类加载器"><a class="anchor" href="#线程上下文类加载器">#</a> 线程上下文类加载器</h1><div class="note danger no-icon"><p><span class="red">线程上下文类加载器是双亲委派模式的破坏者</span></p></div><ul><li>在 <code>Java</code> 应用中存在着很多服务提供者接口 ( <code>Service Provider Interface</code> 简称： <code>SPI</code> )，这些接口允许第三方为它们提供具体实现。</li><li>常见的 <code>SPI</code> 有 <code>JDBC</code> 、 <code>JNDI</code> 等，这些 <code>SPI</code> 的接口属于 <code>Java</code> 核心库，一般存在 <code>rt.jar</code> 包中，由 <code>Bootstrap</code> 类加载器加载。</li><li>而 <code>SPI</code> 的第三方具体实现的代码则是作为 <code>Java</code> 应用所依赖的 <code>jar</code> 包被存放在 <code>classpath</code> 路径下。</li><li>由于 <code>SPI</code> 接口中的代码经常需要加载具体的第三方实现类并调用其相关方法，但 <code>SPI</code> 的核心接口类是由<a href="#%E5%BC%95%E5%AF%BCbootstrap%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">引导类加载器</a>来加载的。</li><li>而 <code>Bootstrap</code> 类加载器无法直接加载 <code>SPI</code> 的具体实现类，同时由于<a href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%BC%8F"> <code>双亲委派模式</code> </a>的存在， <code>Bootstrap</code> 类加载器也无法反向委托给 <code>AppClassLoader</code> 加载器来加载 <code>SPI</code> 的具体实现类。</li><li>这种情况下我们就需要一种特殊的类加载器来加载第三方类库，而线程上下文类加载器就是个很好的选择。</li><li>线程上下文类加载器 ( <code>ContextClassLoader</code> ) 是从 <code>Java 1.2</code> 开始引入的，我们可以通过 <code>java.lang.Thread</code> 类中的 <code>getContextClassLoader()</code> 和 <code>setContextClassLoader(ClassLoader cl)</code> 方法来获取和设置线程的上下文类加载器。</li><li>如果没有手动设置上下文类加载器，线程将继承其父线程的上下文类加载器，初始线程的上下文类加载器是<a href="#%E7%B3%BB%E7%BB%9Fsystem%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%BA%94%E7%94%A8app%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8">应用类加载器</a> ( <code>AppClassLoader</code> )，在线程中运行的代码可以通过此类加载器来加载类和资源，以 <code>jdbc.jar</code> 加载为例，如图所示。<br><img data-src="https://z1.ax1x.com/2023/12/04/piyBG24.png" alt="piyBG24.png"></li><li>从图中可以看出 <code>rt.jar</code> 核心包是由 <code>Bootstrap</code> 类加载器加载的，其内包含 <code>SPI</code> 核心接口类，由于 <code>SPI</code> 中的类经常需要调用外部实现类的方法，而 <code>jdbc.jar</code> 包含外部实现类 ( <code>jdbc.jar</code> 存在于 <code>classpath</code> 路径下) 无法通过 <code>Bootstrap</code> 类加载器加载，因此只能委托线程上下文类加载器把 <code>jdbc.jar</code> 中的实现类加载到内存以便 <code>SPI</code> 相关类使用。</li><li>显然这种线程上下文类加载器的加载方式破坏了 <code>双亲委派模式</code> ，它在执行过程中抛弃了 <code>双亲委派模式</code> ，使程序可以逆向使用类加载器，当然这也使得 <code>Java</code> 类加载器变得更加灵活。</li></ul><blockquote><p>接下来看 <code>DriverManager</code> 类的源码， <code>DriverManager</code> 是 <code>Java</code> 核心 <code>rt.jar</code> 包中的类，该类用来管理不同数据库的实现驱动 (即 <code>Driver</code> )，它们都实现了 <code>Java</code> 核心包中的 <code>java.sql.Driver</code> 接口，如： <code>mysql</code> 驱动包中的 <code>com.mysql.jdbc.Driver</code> ，在这里只要看看如何加载外部实现类，在 <code>DriverManager</code> 初始化时将会执行如下代码。</p></blockquote><figure class="highlight java"><figcaption data-lang="java"><span>DriverManager.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlOHUyMTEtbGF0ZXItYXJjaGl2ZS1kb3dubG9hZHMuaHRtbA==">参考JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>sql</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DriverManager</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token comment">/**</span></pre></td></tr><tr><td data-num="6"></td><td><pre>     * Load the initial JDBC drivers by checking the System property</pre></td></tr><tr><td data-num="7"></td><td><pre>     * jdbc.properties and then use the &#123;@code ServiceLoader&#125; mechanism</pre></td></tr><tr><td data-num="8"></td><td><pre>     */</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token comment">// 执行该方法</span></pre></td></tr><tr><td data-num="11"></td><td><pre>        <span class="token function">loadInitialDrivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"JDBC DriverManager initialized"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token comment">//loadInitialDrivers 方法</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">loadInitialDrivers</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>        <span class="token class-name">String</span> drivers<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>        <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>            drivers <span class="token operator">=</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>                <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>                    <span class="token keyword">return</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">"jdbc.drivers"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>        <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>            drivers <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="27"></td><td><pre>        <span class="token comment">// If the driver is packaged as a Service Provider, load it.</span></pre></td></tr><tr><td data-num="28"></td><td><pre>        <span class="token comment">// Get all the drivers through the classloader</span></pre></td></tr><tr><td data-num="29"></td><td><pre>        <span class="token comment">// exposed as a java.sql.Driver.class service.</span></pre></td></tr><tr><td data-num="30"></td><td><pre>        <span class="token comment">// ServiceLoader.load() replaces the sun.misc.Providers()</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>        <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>            <span class="token keyword">public</span> <span class="token class-name">Void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>                <span class="token comment">// 加载外部的 Driver 的实现类</span></pre></td></tr><tr><td data-num="35"></td><td><pre>                <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Driver</span><span class="token punctuation">></span></span> loadedDrivers <span class="token operator">=</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Driver</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre>                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Driver</span><span class="token punctuation">></span></span> driversIterator <span class="token operator">=</span> loadedDrivers<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="37"></td><td><pre></pre></td></tr><tr><td data-num="38"></td><td><pre>                <span class="token comment">/* Load these drivers, so that they can be instantiated.</span></pre></td></tr><tr><td data-num="39"></td><td><pre>                 * It may be the case that the driver class may not be there</pre></td></tr><tr><td data-num="40"></td><td><pre>                 * i.e. there may be a packaged driver with the service class</pre></td></tr><tr><td data-num="41"></td><td><pre>                 * as implementation of java.sql.Driver but the actual class</pre></td></tr><tr><td data-num="42"></td><td><pre>                 * may be missing. In that case a java.util.ServiceConfigurationError</pre></td></tr><tr><td data-num="43"></td><td><pre>                 * will be thrown at runtime by the VM trying to locate</pre></td></tr><tr><td data-num="44"></td><td><pre>                 * and load the service.</pre></td></tr><tr><td data-num="45"></td><td><pre>                 *</pre></td></tr><tr><td data-num="46"></td><td><pre>                 * Adding a try catch block to catch those runtime errors</pre></td></tr><tr><td data-num="47"></td><td><pre>                 * if driver not available in classpath but it's</pre></td></tr><tr><td data-num="48"></td><td><pre>                 * packaged as service and that service is there in classpath.</pre></td></tr><tr><td data-num="49"></td><td><pre>                 */</pre></td></tr><tr><td data-num="50"></td><td><pre>                <span class="token keyword">try</span><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>                    <span class="token keyword">while</span><span class="token punctuation">(</span>driversIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="52"></td><td><pre>                        driversIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>                    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>                <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>                <span class="token comment">// Do nothing</span></pre></td></tr><tr><td data-num="56"></td><td><pre>                <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>                <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>        <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DriverManager.initialize: jdbc.drivers = "</span> <span class="token operator">+</span> drivers<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>drivers <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> drivers<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>            <span class="token keyword">return</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="66"></td><td><pre>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> driversList <span class="token operator">=</span> drivers<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">":"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"number of Drivers:"</span> <span class="token operator">+</span> driversList<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> aDriver <span class="token operator">:</span> driversList<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DriverManager.Initialize: loading "</span> <span class="token operator">+</span> aDriver<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>aDriver<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                        <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="74"></td><td><pre>                <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"DriverManager.Initialize: load failed: "</span> <span class="token operator">+</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>            <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="78"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>在 <code>DriverManager</code> 类初始化执行了 <code>loadInitialDrivers()</code> 方法，在该方法中通过 <code>ServiceLoader.load(Diver.class)</code> 去加载外部实现的驱动类， <code>ServiceLoader</code> 类会去读取 <code>mysql</code> 的 <code>jdbc.jar</code> 下的 <code>META-INF</code> 文件的内容如下：</p></blockquote><p><img data-src="https://z1.ax1x.com/2023/12/04/pi6mUXj.png" alt="pi6mUXj.png"></p><blockquote><p>而 <code>com.mysql.jdbc.Driver</code> 继承类如下：</p></blockquote><figure class="highlight java"><figcaption data-lang="java"><span>Driver.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlOHUyMTEtbGF0ZXItYXJjaGl2ZS1kb3dubG9hZHMuaHRtbA==">参考JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>jdbc</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Driver</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>mysql<span class="token punctuation">.</span>cj<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span>Driver</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">public</span> <span class="token class-name">Driver</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">static</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token class-name">System</span><span class="token punctuation">.</span>err<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Loading class `com.mysql.jdbc.Driver'. This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver'. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary."</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>从注释中可以看出平常我们使用 <code>com.mysql.jdbc.Driver</code> 已经被丢弃了，取而代之的是 <code>com.mysql.cj.jdbc.Driver</code> ，也就是说官方不再建议我们使用如下代码注册 <code>mysql</code> 驱动。</p></blockquote><figure class="highlight java"><figcaption data-lang="java"><span>RegisterDriver.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="8"></td><td><pre> * @Description: 注册 MySQL 驱动</pre></td></tr><tr><td data-num="9"></td><td><pre> * @DateTime: 2023-12-04 21:58</pre></td></tr><tr><td data-num="10"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="11"></td><td><pre> **/</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterDriver</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">registerMysql</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 不建议使用该方式注册驱动类</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">"com.mysql.jdbc.Driver"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"jdbc:mysql://localhost:3306/cckfs?characterEncoding=UTF-8"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token comment">// 通过 java 库获取数据库连接</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token keyword">return</span> conn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>而是去掉注册步骤，如下即可。</p></blockquote><figure class="highlight java"><figcaption data-lang="java"><span>RegisterDriver.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9kb3dubG9hZHMvYXJjaGl2ZS8=">版本请选择JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">top<span class="token punctuation">.</span>rem<span class="token punctuation">.</span>rain</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">Connection</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">SQLException</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment">/**</span></pre></td></tr><tr><td data-num="7"></td><td><pre> * @Author: LightRain</pre></td></tr><tr><td data-num="8"></td><td><pre> * @Description: 注册 MySQL 驱动</pre></td></tr><tr><td data-num="9"></td><td><pre> * @DateTime: 2023-12-04 21:58</pre></td></tr><tr><td data-num="10"></td><td><pre> * @Version：1.0</pre></td></tr><tr><td data-num="11"></td><td><pre> **/</pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RegisterDriver</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token keyword">public</span> <span class="token class-name">Connection</span> <span class="token function">registerMysql</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">SQLException</span><span class="token punctuation">,</span> <span class="token class-name">ClassNotFoundException</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token comment">// 不建议使用该方式注册驱动类</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token string">"jdbc:mysql://localhost:3306/cckfs?characterEncoding=UTF-8"</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token comment">// 通过 java 库获取数据库连接</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token class-name">Connection</span> conn <span class="token operator">=</span> <span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span>DriverManager</span><span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> <span class="token string">"root"</span><span class="token punctuation">,</span> <span class="token string">"123456"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token keyword">return</span> conn<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><blockquote><p>这样 <code>ServiceLoader</code> 就会帮助我们处理一切，并最终通过 <code>load()</code> 方法加载，来看看具体方法实现。</p></blockquote><figure class="highlight java"><figcaption data-lang="java"><span>ServiceLoader.java</span><span class="exturl" data-url="aHR0cHM6Ly93d3cub3JhY2xlLmNvbS9qYXZhL3RlY2hub2xvZ2llcy9qYXZhc2UvamF2YXNlOHUyMTEtbGF0ZXItYXJjaGl2ZS1kb3dubG9hZHMuaHRtbA==">参考JAVA 8</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">package</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token keyword">implements</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token class-name">ServiceLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">S</span><span class="token punctuation">></span></span> service<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>        <span class="token comment">// 通过线程上下文类加载器来加载</span></pre></td></tr><tr><td data-num="6"></td><td><pre>        <span class="token class-name">ClassLoader</span> cl <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token keyword">return</span> <span class="token class-name">ServiceLoader</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>service<span class="token punctuation">,</span> cl<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><ul><li>很显然确实是通过线程上下文类加载器加载的，实际上核心包的 <code>SPI</code> 类对外部实现类的加载都是线程上下文类加载器执行的，通过这种方式实现了 <code>Java</code> 核心代码内部去调用外部实现类。</li><li>我们知道线程上下文类加载器默认情况下就是 <code>AppClassLoader</code> ，那为什么不直接通过 <code>getSystemClassLoader()</code> 方法获取类加载器来加载 <code>classpath</code> 路径下的类呢？是可以的，但这种直接使用 <code>getSystemClassLoader()</code> 方法获取 <code>AppClassLoader</code> 加载类会有一个缺点，那就是代码部署到不同服务器上时会出现问题。</li><li>如果代码部署到 <code>Java Web</code> 应用服务或者 <code>EJB</code> 之类的服务将会出现问题，以为这些服务器使用的线程上下文类加载器并非 <code>AppClassLoader</code> ，而是 <code>Java Web</code> 应用服务器自家的类加载器，类加载器不同，所以我们应该少用 <code>getSystemClassLoader()</code> 。</li><li>总之不同服务使用的可能默认 <code>ClassLoader</code> 是不同的，但使用线程上下文类加载器总能获取到当前程序执行相同的 <code>ClassLoader</code> ，从而避免不必要的问题。</li></ul><div class="tags"><a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/" rel="tag"><i class="ic i-tag"></i> 计算机科学</a> <a href="/tags/Java/" rel="tag"><i class="ic i-tag"></i> Java</a> <a href="/tags/Java%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" rel="tag"><i class="ic i-tag"></i> Java高级特性</a> <a href="/tags/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8/" rel="tag"><i class="ic i-tag"></i> Java类加载器</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-12-05 20:39:59" itemprop="dateModified" datetime="2023-12-05T20:39:59+08:00">2023-12-05</time> </span><span id="计算机科学/java/java深入理解/Java类加载器深入理解/" class="item leancloud_visitors" data-flag-title="Java类加载器深入理解" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Light Rain 微信支付"><p>微信支付</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Light Rain <i class="ic i-at"><em>@</em></i>雨的记忆</li><li class="link"><strong>本文链接：</strong> <a href="https://rainrem.top/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" title="Java类加载器深入理解">https://rainrem.top/计算机科学/java/java深入理解/Java类加载器深入理解/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC96aC1DTg=="><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E5%9F%BA%E7%A1%80/Java%E5%85%AB%E7%A7%8D%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;www.dmoe.cc&#x2F;random.php?870209" title="Java八种基本数据类型"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> Java基础</span><h3>Java八种基本数据类型</h3></a></div><div class="item right"><a href="/%E6%95%A3%E7%AB%A0/%E7%A1%AC%E4%BB%B6%E5%BD%92%E7%BA%B3/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;www.dmoe.cc&#x2F;random.php?494339" title="电阻公式"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 硬件</span><h3>电阻公式</h3></a></div></div><div class="wrap" id="comments" name="msg"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.</span> <span class="toc-text">类加载执行流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">2.</span> <span class="toc-text">三种方式类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%AF%BCbootstrap%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">2.1.</span> <span class="toc-text">引导 (Bootstrap) 类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#java8"><span class="toc-number">2.1.1.</span> <span class="toc-text">Java8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java9"><span class="toc-number">2.1.2.</span> <span class="toc-text">Java9</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95extension%E5%B9%B3%E5%8F%B0platform%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">2.2.</span> <span class="toc-text">扩展 (Extension)&amp; 平台 (Platform) 类加载器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#java8-%E6%89%A9%E5%B1%95extension"><span class="toc-number">2.2.1.</span> <span class="toc-text">Java8 - 扩展 (Extension)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#java9-%E5%B9%B3%E5%8F%B0platform"><span class="toc-number">2.2.2.</span> <span class="toc-text">Java9 - 平台 (Platform)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9Fsystem%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E5%BA%94%E7%94%A8app%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">2.3.</span> <span class="toc-text">系统 (System) 类加载器 &amp; 应用 (App) 类加载器</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">双亲委派模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">3.1.</span> <span class="toc-text">双亲委派工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E4%B8%BB%E8%A6%81%E7%94%A8%E9%80%94"><span class="toc-number">3.2.</span> <span class="toc-text">双亲委派主要用途</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E5%85%B3%E7%B3%BB%E5%9B%BE"><span class="toc-number">3.3.</span> <span class="toc-text">双亲委派关系图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#classloader%E5%B8%B8%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">3.4.</span> <span class="toc-text">ClassLoader 常用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#loadclasssting"><span class="toc-number">3.4.1.</span> <span class="toc-text">loadClass(Sting)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#findclasssting"><span class="toc-number">3.4.2.</span> <span class="toc-text">findClass(Sting)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#defineclassbyte-b-int-off-int-len"><span class="toc-number">3.4.3.</span> <span class="toc-text">defineClass(byte[] b, int off, int len)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#resolveclassclass-c"><span class="toc-number">3.4.4.</span> <span class="toc-text">resolveClass(Class&lt;?&gt; c)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sercureclassloader%E6%89%A9%E5%B1%95-classloader"><span class="toc-number">3.5.</span> <span class="toc-text">SercureClassLoader 扩展 - ClassLoader</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#urlclassloaderurlclasspath"><span class="toc-number">3.5.1.</span> <span class="toc-text">URLClassLoader&amp;URLClassPath</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#appsystemclassloaderextclassloader"><span class="toc-number">3.5.2.</span> <span class="toc-text">App(System)ClassLoader&amp;ExtClassLoader</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">4.</span> <span class="toc-text">类加载器之间的关系</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%B1%BB%E4%B8%8E%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">5.</span> <span class="toc-text">类与类加载器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#class%E6%96%87%E4%BB%B6%E6%98%BE%E7%A4%BA%E9%9A%90%E5%BC%8F%E5%8A%A0%E8%BD%BD%E6%A6%82%E5%BF%B5"><span class="toc-number">6.</span> <span class="toc-text">class 文件显示 &amp; 隐式加载概念</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">7.</span> <span class="toc-text">实现自定义类加载器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89file%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">8.</span> <span class="toc-text">自定义 File 类加载器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">9.</span> <span class="toc-text">自定义网络类加载器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%83%AD%E9%83%A8%E7%BD%B2%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">10.</span> <span class="toc-text">实现热部署类加载器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E4%B8%8A%E4%B8%8B%E6%96%87%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">11.</span> <span class="toc-text">线程上下文类加载器</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E6%B3%A8%E8%A7%A3%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="bookmark" title="Java注解深入理解">Java注解深入理解</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E7%B1%BB%E5%9E%8B%E4%B8%8E%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="bookmark" title="Java类型与反射机制深入理解">Java类型与反射机制深入理解</a></li><li class="active"><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%99%A8%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="bookmark" title="Java类加载器深入理解">Java类加载器深入理解</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E6%9E%9A%E4%B8%BE%E7%B1%BB%E5%9E%8B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="bookmark" title="Java枚举类型深入理解">Java枚举类型深入理解</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E4%BD%8D%E8%BF%90%E7%AE%97%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="bookmark" title="Java位运算深入理解">Java位运算深入理解</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/JavaEquals%E4%B8%8EHashCode%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="bookmark" title="Java equals与hashCode深入理解">Java equals与hashCode深入理解</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E5%B9%B6%E5%8F%91%E4%B9%8Bsynchronized%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="bookmark" title="Java并发之synchronized深入理解">Java并发之synchronized深入理解</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B%E5%8F%8Avolatile%E5%85%B3%E9%94%AE%E5%AD%97%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="bookmark" title="Java内存模型及volatile关键字深入理解">Java内存模型及volatile关键字深入理解</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/spring/SpringIOC%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-DI%E4%BE%9D%E8%B5%96%E6%B3%A8%E5%85%A5/" rel="bookmark" title="SpringIOC深入理解-DI依赖注入">SpringIOC深入理解-DI依赖注入</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/spring/SpringAop%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-AspectJ/" rel="bookmark" title="SpringAop深入理解-AspectJ">SpringAop深入理解-AspectJ</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/" rel="bookmark" title="Java多线程深入理解">Java多线程深入理解</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BExecutor%E6%A1%86%E6%9E%B6/" rel="bookmark" title="Java多线程-Executor框架">Java多线程-Executor框架</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3/Java%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BCallable%E5%92%8CFuture%E6%8E%A5%E5%8F%A3/" rel="bookmark" title="Java多线程之Callable和Future接口">Java多线程之Callable和Future接口</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/spring/SpringBoot3%E5%8E%9F%E7%90%86%E4%B8%8E%E6%A0%B8%E5%BF%83/" rel="bookmark" title="SpringBoot3原理与核心">SpringBoot3原理与核心</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/spring/SpringBoot&%E5%85%B6%E5%AE%83%E5%B8%B8%E7%94%A8%E6%B3%A8%E8%A7%A3/" rel="bookmark" title="SpringBoot&其它常用注解">SpringBoot&其它常用注解</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/spring/SpringBoot%E6%97%A5%E5%BF%97%E6%89%93%E5%8D%B0/" rel="bookmark" title="SpringBoot日志打印">SpringBoot日志打印</a></li><li><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/spring/Spring%20Security-6.3.1%E7%89%88%E6%9C%AC%E5%AE%89%E5%85%A8%E9%85%8D%E7%BD%AE/" rel="bookmark" title="Spring Security-6.3.1版本安全配置">Spring Security-6.3.1版本安全配置</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Light Rain" data-src="/images/02.jpg"><p class="name" itemprop="name">Light Rain</p><div class="description" itemprop="description">我还在原地等你，你却已经忘记曾来过这里</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">55</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">31</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">64</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JhaW4yMzgvUmFpbjIzOC5naXRodWIuaW8=" title="https:&#x2F;&#x2F;github.com&#x2F;Rain238&#x2F;Rain238.github.io"><i class="ic i-github"></i></span> <span class="exturl item gitee" data-url="aHR0cHM6Ly9naXRlZS5jb20vUmFpblNhdWNl" title="https:&#x2F;&#x2F;gitee.com&#x2F;RainSauce"><i class="ic i-github"></i></span> <span class="exturl item qq" data-url="aHR0cHM6Ly91c2VyLnF6b25lLnFxLmNvbS8zMTY0Mzk1NzMw" title="https:&#x2F;&#x2F;user.qzone.qq.com&#x2F;3164395730"><i class="ic i-qq"></i></span> <span class="exturl item email" data-url="bWFpbHRvOjMxNjQzOTU3MzBAcXEuY29t" title="mailto:3164395730@qq.com"><i class="ic i-envelope"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-magic"></i>链环</a><ul class="submenu"><li class="item"><a href="/friends/" rel="section"><i class="ic i-heart"></i>友達</a></li><li class="item"><a href="/webstack/" rel="section"><i class="ic i-star"></i>网址</a></li></ul></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-coffee"></i>手办</a><ul class="submenu"><li class="item"><span class="exturl" data-url="aHR0cHM6Ly93d3cuYW1pYW1pLmNvbS9jbi8="><i class="ic i-link-circle"></i>Amiami</span></li><li class="item"><span class="exturl" data-url="aHR0cHM6Ly93d3cuaHBvaS5uZXQuY24vaW5kZXgvaG9tZS8="><i class="ic i-link-circle"></i>手办维基</span></li><li class="item"><span class="exturl" data-url="aHR0cHM6Ly93d3cuMDMwYnV5Lm5ldC8="><i class="ic i-link-circle"></i>萌购任你购</span></li><li class="item"><span class="exturl" data-url="aHR0cHM6Ly93d3cubmF0aXZlLXdlYi5qcC8="><i class="ic i-link-circle"></i>ネイティブ</span></li></ul></li></ul></div><h3><span>Pixiv每日榜Top50</span></h3><iframe src="https://cloud.mokeyjay.com/pixiv" frameborder="0" style="width:100%;height:380px;margin:0"></iframe></div></div><link rel="stylesheet" href="./live2d/waifu.css"><div class="waifu"><div class="waifu-tips"></div><canvas id="live2d" class="live2d"></canvas><div class="waifu-tool"></div></div><script type="text/javascript" src="./live2d/waifu-tips.js"></script><script type="text/javascript" src="./live2d/live2d.js"></script><script type="text/javascript" src="./live2d/jquery-3.6.min.js"></script><script type="text/javascript" src="./live2d/jquery-ui.min.js"></script><script type="text/javascript">initModel("./live2d/waifu-tips.json")</script><ul id="quick"><li class="prev pjax"><a href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6/java/java%E5%9F%BA%E7%A1%80/Java%E5%85%AB%E7%A7%8D%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/%E6%95%A3%E7%AB%A0/%E7%A1%AC%E4%BB%B6%E5%BD%92%E7%BA%B3/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright"><span id="sitetime"></span><br>&copy; 2021 – <span itemprop="copyrightYear">2024</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Light Rain @ Daring Traveler</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">930k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">14:05</span></div><div class="powered-by">本站由Hexo & Yume Shoka建成</div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"计算机科学/java/java深入理解/Java类加载器深入理解/",favicon:{show:"✧(≖ ◡ ≖✿)已恢复正常",hide:"´･∀･)乂(･∀･｀失连中..."},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(a){return a.includes("#")},function(a){return new RegExp(LOCAL.path+"$").test(a)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->